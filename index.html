<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–î–æ 27 –¥–µ–∫–∞–±—Ä—è 2025</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --edge:#1c2842;
      --text:#eaf2ff;
      --muted:#97a2bf;

      /* –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∞–∫—Ü–µ–Ω—Ç—ã */
      --green:#62d36a;
      --red:#ff4d6d;
      --gold:#ffd166;
      --ice:#7bdff2;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 0%, #0e1830 0, var(--bg) 60%),
        radial-gradient(800px 400px at 80% 20%, #0e1830 0, var(--bg) 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* –º—è–≥–∫–∏–µ ‚Äú–æ–≥–æ–Ω—å–∫–∏‚Äù –∏ –∏—Å–∫—Ä—ã –ø–æ —Ñ–æ–Ω—É */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(2px 2px at 12% 18%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 78% 22%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(2px 2px at 44% 72%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(160px 160px at 14% 85%, rgba(98,211,106,.12), transparent 60%),
        radial-gradient(220px 220px at 88% 16%, rgba(255,77,109,.12), transparent 60%),
        radial-gradient(180px 180px at 52% 10%, rgba(255,209,102,.10), transparent 60%);
      z-index:0;
    }

    /* ===== –≤–µ—Ä—Ö–Ω—è—è –≥–∏—Ä–ª—è–Ω–¥–∞ ===== */
    #topGarland{
      position:fixed;
      left:0; right:0; top:0;
      height:86px;
      pointer-events:none;
      z-index:18;
      filter: drop-shadow(0 12px 28px rgba(0,0,0,.35));
    }
    #topGarland svg{
      position:absolute; inset:0;
      width:100%; height:100%;
    }
    #topGarland .bulbs{
      position:absolute; inset:0;
    }
    #topGarland .bulb{
      position:absolute;
      top:44px;
      width:12px; height:12px;
      border-radius:50%;
      background: var(--c);
      box-shadow: 0 0 10px rgba(255,255,255,.18), 0 0 26px var(--c);
      transform:translate(-50%, -50%);
      animation: bulbBlink 1.35s ease-in-out infinite alternate;
      animation-delay: var(--d);
    }
    #topGarland .bulb::after{
      content:"";
      position:absolute;
      left:50%; top:-7px;
      transform:translateX(-50%);
      width:7px; height:7px;
      border-radius:3px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
    }

    @keyframes bulbBlink{
      from{ filter:brightness(.75); opacity:.85; }
      to{ filter:brightness(1.45); opacity:1; }
    }

    header{
      text-align:center;
      padding:110px 16px 8px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –≥–∏—Ä–ª—è–Ω–¥—É */
      line-height:1.2;
      position:relative;
      z-index:20;
    }
    h1{
      margin:0;
      font-size:clamp(1.4rem, 3.5vw, 2.2rem);
      font-weight:800;
      letter-spacing:.3px
    }
    #targetLabel{
      color:var(--gold);
      text-shadow:0 0 18px rgba(255,209,102,.25);
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:clamp(.9rem, 2.2vw, 1rem)
    }

    .wrap{
      max-width:1024px;
      margin:0 auto;
      padding:12px 16px 340px; /* –º–µ—Å—Ç–æ –ø–æ–¥ —Å—É–≥—Ä–æ–±—ã + —ë–ª–∫—É */
      position:relative;
      z-index:20;
    }

    .timer{
      display:grid;
      grid-template-columns:repeat(4, minmax(130px, 1fr));
      gap:14px;
      align-items:stretch;
      margin-top:18px;
    }
    .unit{
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08)),
        var(--card);
      border:1px solid var(--edge);
      border-radius:18px;
      padding:18px 16px;
      text-align:center;
      box-shadow:0 30px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
      position:relative;
      overflow:hidden;
    }
    .unit::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%);
      pointer-events:none;
    }
    .label{
      color:var(--muted);
      font-weight:600;
      font-size:.92rem;
      letter-spacing:.32px;
      text-transform:uppercase
    }
    .value{
      font-variant-numeric:tabular-nums slashed-zero;
      line-height:1;
      margin-top:10px;
      font-weight:900;
      letter-spacing:.5px;
      font-size:clamp(2.4rem, 9vw, 4.4rem);
      text-shadow:0 6px 22px rgba(0,0,0,.45);
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:center;
      margin-top:18px
    }
    .btn{
      appearance:none;
      border:1px solid var(--edge);
      color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08));
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      transition:.2s transform, .2s filter, .2s background;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .hint{color:var(--muted); text-align:center; margin-top:6px; font-size:.92rem}

    /* ===== –°–ù–ï–ì (canvas) ===== */
    #snow{
      position:fixed; inset:0;
      z-index:6;
      pointer-events:none;
      opacity:.9;
    }

    /* ===== —Å—É–≥—Ä–æ–±—ã ===== */
    #snowbanks{
      position:fixed;
      left:0; right:0; bottom:0;
      height:190px;
      z-index:8;
      pointer-events:none;
      background:linear-gradient(180deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,.16) 18%,
        rgba(255,255,255,.34) 55%,
        rgba(255,255,255,.50) 100%);
      filter: drop-shadow(0 -14px 30px rgba(255,255,255,.06));
    }
    #snowbanks::before{
      content:"";
      position:absolute;
      left:-50px; right:-50px;
      top:-46px;
      height:96px;
      background:
        radial-gradient(circle at 44px 78px, rgba(255,255,255,.62) 0 44px, transparent 46px);
      background-size: 92px 92px;
      background-repeat: repeat-x;
      opacity:.95;
      filter: blur(.2px);
    }
    #snowbanks::after{
      content:"";
      position:absolute;
      left:-70px; right:-70px;
      top:-26px;
      height:84px;
      background:
        radial-gradient(circle at 56px 66px, rgba(255,255,255,.35) 0 36px, transparent 38px);
      background-size: 118px 84px;
      background-repeat: repeat-x;
      opacity:.8;
      filter: blur(.7px);
    }

    /* —á—É—Ç—å ‚Äú—Å–Ω–µ–≥–∞‚Äù –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .unit{
      backdrop-filter: blur(6px);
    }

    /* ===== –Å–ª–∫–∞ (3D) –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É ===== */
    #treeWrap{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      width:260px;
      height:290px;
      z-index:10;
      pointer-events:none;
      filter: drop-shadow(0 18px 34px rgba(0,0,0,.48));
    }

    .treeStar{
      position:absolute;
      left:50%;
      top:2px;
      transform:translateX(-50%);
      width:36px; height:36px;
      background:radial-gradient(circle at 30% 30%, #fff6d6, var(--gold));
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 56%, 79% 92%, 50% 70%, 21% 92%, 32% 56%, 2% 35%, 39% 35%);
      filter: drop-shadow(0 0 18px rgba(255,209,102,.45));
      animation: starPulse 1.6s ease-in-out infinite alternate;
    }
    @keyframes starPulse{
      from{ transform:translateX(-50%) scale(1); }
      to{ transform:translateX(-50%) scale(1.06); }
    }

    .tree{
      position:absolute;
      left:50%;
      bottom:0;
      transform:translateX(-50%);
      width:260px;
      height:290px;
    }

    .layer{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width:240px;
      height:150px;
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      border:1px solid rgba(0,0,0,.18);
      box-shadow:
        inset 0 14px 28px rgba(255,255,255,.10),
        inset -28px -22px 40px rgba(0,0,0,.18);
      overflow:hidden;
    }
    /* ‚Äú–∏–≥–æ–ª–∫–∏‚Äù + –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è 3D */
    .layer::before{
      content:"";
      position:absolute; inset:-10px;
      background:
        repeating-linear-gradient(135deg, rgba(255,255,255,.06) 0 2px, transparent 2px 10px),
        radial-gradient(circle at 28% 18%, rgba(255,255,255,.18), transparent 55%);
      opacity:.9;
      mix-blend-mode: screen;
    }
    .layer::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(0,0,0,.0), rgba(0,0,0,.22));
      opacity:.8;
    }

    .l1{ top:24px;  width:190px; height:120px; background:linear-gradient(180deg, #6af08f, #1e9b45); }
    .l2{ top:82px;  width:220px; height:135px; background:linear-gradient(180deg, #58e981, #1b8e3e); }
    .l3{ top:144px; width:250px; height:150px; background:linear-gradient(180deg, #49db73, #177f35); }

    .trunk{
      position:absolute;
      left:50%;
      bottom:28px;
      transform:translateX(-50%);
      width:52px;
      height:64px;
      border-radius:12px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.10), rgba(0,0,0,.18)),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.16)),
        #7a4b2a;
      border:1px solid rgba(0,0,0,.25);
      box-shadow: inset 0 10px 18px rgba(0,0,0,.18);
    }

    .snowBase{
      position:absolute;
      left:50%;
      bottom:0;
      transform:translateX(-50%);
      width:240px;
      height:64px;
      border-radius:999px;
      background:
        radial-gradient(circle at 38% 30%, rgba(255,255,255,.92), rgba(255,255,255,.56) 55%, rgba(255,255,255,.22) 100%);
      opacity:.9;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 10px 22px rgba(255,255,255,.15);
    }

    /* –≥–∏—Ä–ª—è–Ω–¥–∞ –Ω–∞ —ë–ª–∫–µ */
    .garland{
      position:absolute;
      left:50%;
      top:92px;
      transform:translateX(-50%);
      width:232px;
      height:140px;
      z-index:2;
    }
    .garland::before{
      content:"";
      position:absolute;
      left:0; right:0;
      top:18px;
      height:110px;
      border-bottom:2px solid rgba(255,255,255,.32);
      border-radius:0 0 260px 260px;
      filter: drop-shadow(0 0 12px rgba(255,255,255,.10));
    }

    .garland .bulb{
      position:absolute;
      left:var(--x);
      top:var(--y);
      width:12px; height:12px;
      border-radius:50%;
      background: var(--c);
      box-shadow: 0 0 10px rgba(255,255,255,.20), 0 0 26px var(--c);
      animation: bulbBlink 1.25s ease-in-out infinite alternate;
      animation-delay: var(--d);
    }
    .garland .bulb::after{
      content:"";
      position:absolute;
      left:50%;
      top:-6px;
      transform:translateX(-50%);
      width:7px; height:7px;
      border-radius:3px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
    }

    /* ===== —Å–∞–ª—é—Ç ===== */
    #fx{position:fixed; inset:0; opacity:0; pointer-events:none; transition:opacity .35s ease; display:block; z-index:50;}
    #fx.show{opacity:1}
    #fxBack{
      position:fixed; inset:0;
      background:radial-gradient(1000px 500px at 50% 60%, rgba(255,255,255,.05), rgba(0,0,0,.7));
      opacity:0; pointer-events:none; transition:opacity .35s ease; z-index:49;
    }
    #fxBack.show{opacity:1}

    /* ===== –æ–≤–µ—Ä–ª–µ–π –∫–∞—Ä—Ç–∏–Ω–æ–∫/—Ç–µ–∫—Å—Ç–∞ ===== */
    #overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.6);
      opacity:0; pointer-events:none; transition:opacity .35s ease; z-index:60;
    }
    #overlay.show{ opacity:1; pointer-events:auto; }
    #overlay img, #overlay #ovText{ display:none; max-width:min(90vw, 640px); max-height:80vh; }
    #overlay .visible{ display:block; animation:pop .35s ease; }
    @keyframes pop{ 0%{transform:scale(.9);opacity:.001} 100%{transform:scale(1);opacity:1} }

    /* —É—Å–∏–ª–µ–Ω–Ω–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è "–æ–π" */
    #ovText{ display:none; }
    #overlay #ovText.visible{
      display:block;
      font-size:min(18vw, 180px);
      line-height:1;
      font-weight:900;
      color:#fff;
      text-transform:uppercase;
      text-shadow:0 6px 20px rgba(0,0,0,.9), 0 0 40px rgba(255,255,255,.35);
      -webkit-text-stroke:4px rgba(0,0,0,.45);
      letter-spacing:.04em;
      padding:.1em .2em;
      border-radius:16px;
    }

    @media (max-width: 640px){
      .timer{grid-template-columns:repeat(2, minmax(130px,1fr))}
      #treeWrap{ transform:translateX(-50%) scale(.86); bottom:14px; }
      .wrap{ padding-bottom:320px; }
    }

    @media (prefers-reduced-motion: reduce){
      #snow{ display:none; }
      .bulb{ animation:none !important; }
      .treeStar{ animation:none !important; }
    }
  </style>
</head>

<body>
  <!-- –≤–µ—Ä—Ö–Ω—è—è –≥–∏—Ä–ª—è–Ω–¥–∞ -->
  <div id="topGarland" aria-hidden="true">
    <svg viewBox="0 0 1000 120" preserveAspectRatio="none">
      <path d="M0,70 C120,10 220,120 330,70 C440,20 560,120 670,70 C780,15 890,120 1000,70"
            fill="none" stroke="rgba(255,255,255,.40)" stroke-width="3" />
      <path d="M0,72 C120,12 220,122 330,72 C440,22 560,122 670,72 C780,17 890,122 1000,72"
            fill="none" stroke="rgba(0,0,0,.22)" stroke-width="5" opacity=".55"/>
    </svg>
    <div class="bulbs">
      <!-- –ª–∞–º–ø–æ—á–∫–∏ –ø–æ –≤–µ—Ä—Ö–Ω–µ–π –≥–∏—Ä–ª—è–Ω–¥–µ -->
      <span class="bulb" style="left:6%;  --c:var(--gold); --d:0.0s"></span>
      <span class="bulb" style="left:12%; --c:var(--ice);  --d:0.2s"></span>
      <span class="bulb" style="left:18%; --c:var(--red);  --d:0.4s"></span>
      <span class="bulb" style="left:24%; --c:var(--green);--d:0.1s"></span>
      <span class="bulb" style="left:30%; --c:var(--gold); --d:0.3s"></span>
      <span class="bulb" style="left:36%; --c:var(--ice);  --d:0.5s"></span>
      <span class="bulb" style="left:42%; --c:var(--red);  --d:0.25s"></span>
      <span class="bulb" style="left:48%; --c:var(--green);--d:0.45s"></span>
      <span class="bulb" style="left:54%; --c:var(--gold); --d:0.15s"></span>
      <span class="bulb" style="left:60%; --c:var(--ice);  --d:0.35s"></span>
      <span class="bulb" style="left:66%; --c:var(--red);  --d:0.55s"></span>
      <span class="bulb" style="left:72%; --c:var(--green);--d:0.05s"></span>
      <span class="bulb" style="left:78%; --c:var(--gold); --d:0.28s"></span>
      <span class="bulb" style="left:84%; --c:var(--ice);  --d:0.48s"></span>
      <span class="bulb" style="left:90%; --c:var(--red);  --d:0.18s"></span>
      <span class="bulb" style="left:96%; --c:var(--green);--d:0.38s"></span>
    </div>
  </div>

  <!-- —Å–Ω–µ–≥ -->
  <canvas id="snow" aria-hidden="true"></canvas>

  <header>
    <h1>–í—Ä–µ–º—è –¥–æ <span id="targetLabel">27 –¥–µ–∫–∞–±—Ä—è 2025</span></h1>
    <div class="sub"></div>
  </header>

  <div class="wrap">
    <section class="timer" role="timer" aria-live="polite" aria-atomic="true">
      <article class="unit" aria-label="–î–Ω–∏">
        <div class="label">–î–Ω–∏</div>
        <div class="value" id="d">00</div>
      </article>
      <article class="unit" aria-label="–ß–∞—Å—ã">
        <div class="label">–ß–∞—Å—ã</div>
        <div class="value" id="h">00</div>
      </article>
      <article class="unit" aria-label="–ú–∏–Ω—É—Ç—ã">
        <div class="label">–ú–∏–Ω—É—Ç—ã</div>
        <div class="value" id="m">00</div>
      </article>
      <article class="unit" aria-label="–°–µ–∫—É–Ω–¥—ã">
        <div class="label">–°–µ–∫—É–Ω–¥—ã</div>
        <div class="value" id="s">00</div>
      </article>
    </section>

    <div class="controls">
      <button class="btn" id="soundBtn" aria-pressed="false" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">üîá –ó–≤—É–∫ –≤—ã–∫–ª.</button>
    </div>
    <div class="hint"></div>
  </div>

  <!-- —Å—É–≥—Ä–æ–±—ã -->
  <div id="snowbanks" aria-hidden="true"></div>

  <!-- —ë–ª–æ—á–∫–∞ -->
  <div id="treeWrap" aria-hidden="true">
    <div class="treeStar"></div>

    <div class="tree">
      <div class="layer l1"></div>
      <div class="layer l2"></div>
      <div class="layer l3"></div>

      <div class="garland">
        <span class="bulb" style="--x:18%;--y:34%;--c:var(--gold); --d:0.0s"></span>
        <span class="bulb" style="--x:30%;--y:40%;--c:var(--ice);  --d:0.2s"></span>
        <span class="bulb" style="--x:44%;--y:46%;--c:var(--red);  --d:0.4s"></span>
        <span class="bulb" style="--x:58%;--y:50%;--c:var(--green);--d:0.1s"></span>
        <span class="bulb" style="--x:72%;--y:46%;--c:var(--gold); --d:0.3s"></span>
        <span class="bulb" style="--x:82%;--y:38%;--c:var(--ice);  --d:0.5s"></span>

        <span class="bulb" style="--x:22%;--y:58%;--c:var(--red);  --d:0.15s"></span>
        <span class="bulb" style="--x:38%;--y:64%;--c:var(--green);--d:0.35s"></span>
        <span class="bulb" style="--x:54%;--y:68%;--c:var(--gold); --d:0.55s"></span>
        <span class="bulb" style="--x:70%;--y:64%;--c:var(--ice);  --d:0.25s"></span>
      </div>

      <div class="trunk"></div>
      <div class="snowBase"></div>
    </div>
  </div>

  <!-- —Å–∞–ª—é—Ç -->
  <div id="fxBack" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true"></canvas>

  <!-- –æ–≤–µ—Ä–ª–µ–π —Ñ–∏–Ω–∞–ª–∞ -->
  <div id="overlay" aria-hidden="true">
    <img id="ovImg1" src="img1.jpg" alt="–ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞" />
    <div id="ovText">–æ–π</div>
    <img id="ovImg2" src="img2.jpg" alt="–í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞" />
  </div>

  <!-- üéµ –î–æ—Ä–æ–∂–∫–∞ —Ñ–∏–Ω–∞–ª–∞; –ø–æ–ª–æ–∂–∏—Ç–µ song.mp3 —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML -->
  <audio id="finalSong" src="song.mp3" preload="auto" loop></audio>

<script>
(function(){
  // ====== –¶–µ–ª—å: 27 –¥–µ–∫–∞–±—Ä—è 2025 00:00 (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞) ======
  const TARGET = new Date(2025, 11, 27, 0, 0, 0, 0); // –º–µ—Å—è—Ü 11 = –¥–µ–∫–∞–±—Ä—å
  const targetLabel = document.getElementById('targetLabel');
  targetLabel.textContent = '27 –¥–µ–∫–∞–±—Ä—è 2025';

  const dom = {
    d: document.getElementById('d'),
    h: document.getElementById('h'),
    m: document.getElementById('m'),
    s: document.getElementById('s')
  };
  const pad2 = n => String(n).padStart(2,'0');
  let prevDays = null;

  let endedFired = false; // –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
  let holdZeroUntil = 0;  // —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –Ω—É–ª–∏, –ø–æ–∫–∞ –∏–¥—ë—Ç –ø–æ–∫–∞–∑ –æ–≤–µ—Ä–ª–µ—è

  function compute(){
    const now = new Date();

    if (!endedFired && now >= TARGET){
      endedFired = true;
      holdZeroUntil = now.getTime() + 4800;

      dom.d.textContent = '00';
      dom.h.textContent = '00';
      dom.m.textContent = '00';
      dom.s.textContent = '00';

      endSequence();
      setTimeout(() => triggerFireworks(Infinity), 0);
    }

    let diff;
    if (Date.now() < holdZeroUntil) diff = 0;
    else diff = Math.max(0, TARGET - now);

    const totalSec = Math.floor(diff / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    const secs = totalSec % 60;

    dom.d.textContent = pad2(days);
    dom.h.textContent = pad2(hours);
    dom.m.textContent = pad2(mins);
    dom.s.textContent = pad2(secs);

    if (prevDays !== null && days !== prevDays && totalSec > 0) {
      triggerFireworks(10_000);
    }
    prevDays = days;
  }
  compute();
  setInterval(compute, 250);

  // ====== –ê—É–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (Web Audio) ======
  let audioCtx = null;
  let audioEnabled = false;

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function playWhistle(duration = 0.9){
    if (!audioEnabled) return;
    ensureAudio();
    const ctx = audioCtx;
    const t0  = ctx.currentTime;

    const osc    = ctx.createOscillator();
    const filter = ctx.createBiquadFilter();
    const gain   = ctx.createGain();
    const panner = (ctx.createStereoPanner‚ÄîallowsPanner()? ctx.createStereoPanner() : null);

    function allowsPanner(){ return !!ctx.createStereoPanner; }

    const hissBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * duration), ctx.sampleRate);
    const hiss    = ctx.createBufferSource(); hiss.buffer = hissBuf;
    const hissF   = ctx.createBiquadFilter(); hissF.type = 'bandpass';
    const hissG   = ctx.createGain();

    const ch = hissBuf.getChannelData(0);
    for (let i=0;i<ch.length;i++){
      const t = i / hissBuf.sampleRate;
      ch[i] = (Math.random()*2 - 1) * (1 - t);
    }

    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.06);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);

    osc.connect(filter).connect(gain);
    if (panner){ gain.connect(panner); panner.connect(ctx.destination); }
    else { gain.connect(ctx.destination); }

    hiss.connect(hissF).connect(hissG).connect(ctx.destination);

    const S = { wave:'triangle', f0: 800+Math.random()*150, f1: 1900+Math.random()*450, vibHz:6.5, vibAmtHz:18, q:14, fil0:1100, fil1:2800, hiss:0.03 };

    osc.type = S.wave;
    osc.frequency.setValueAtTime(S.f0, t0);
    osc.frequency.exponentialRampToValueAtTime(S.f1, t0 + duration * 0.9);

    filter.type = 'bandpass';
    filter.Q.setValueAtTime(S.q, t0);
    filter.frequency.setValueAtTime(S.fil0, t0);
    filter.frequency.exponentialRampToValueAtTime(S.fil1, t0 + duration * 0.9);

    const lfo = ctx.createOscillator();
    const lfoGainNode = ctx.createGain();
    lfo.frequency.setValueAtTime(S.vibHz, t0);
    lfoGainNode.gain.setValueAtTime(S.vibAmtHz, t0);
    lfo.connect(lfoGainNode).connect(osc.frequency);
    lfo.start(t0); lfo.stop(t0 + duration);

    hissF.frequency.setValueAtTime((S.f0+S.f1)/2, t0);
    hissF.Q.setValueAtTime(S.q*0.8, t0);
    hissG.gain.setValueAtTime(S.hiss, t0);
    hiss.start(t0); hiss.stop(t0 + duration);

    if (panner) panner.pan.setValueAtTime((Math.random()*2 - 1) * 0.25, t0);

    osc.start(t0); osc.stop(t0 + duration);
  }

  function playExplosion(){
    if (!audioEnabled) return;
    ensureAudio();
    const ctx = audioCtx; const t0 = ctx.currentTime;

    const boomOsc = ctx.createOscillator();
    const boomGain = ctx.createGain();
    boomOsc.type = 'sine';
    boomOsc.frequency.setValueAtTime(90, t0);
    boomOsc.frequency.exponentialRampToValueAtTime(45, t0 + 1.0);
    boomGain.gain.setValueAtTime(0.6, t0);
    boomGain.gain.exponentialRampToValueAtTime(0.001, t0 + 1.2);
    boomOsc.connect(boomGain).connect(ctx.destination);
    boomOsc.start(t0); boomOsc.stop(t0 + 1.3);

    const buffer = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
    }
    const noise = ctx.createBufferSource(); noise.buffer = buffer;
    const band = ctx.createBiquadFilter(); band.type = 'bandpass'; band.frequency.setValueAtTime(2200, t0);
    const nGain = ctx.createGain();
    nGain.gain.setValueAtTime(0.001, t0);
    nGain.gain.exponentialRampToValueAtTime(0.8, t0 + 0.05);
    nGain.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.4);
    noise.connect(band).connect(nGain).connect(ctx.destination);
    noise.start(t0); noise.stop(t0 + 1.5);

    for (let k = 0; k < 6; k++) {
      playCrackle(t0 + 0.2 + Math.random() * 0.6);
    }
  }

  function playCrackle(atTime){
    if (!audioEnabled) return;
    ensureAudio();
    const ctx = audioCtx;
    const dur = 0.15;
    const buffer = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      const t = i / buffer.sampleRate;
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - t, 2) * (Math.random() > 0.8 ? 1.0 : 0.6);
    }
    const src = ctx.createBufferSource(); src.buffer = buffer;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.25, atTime);
    g.gain.exponentialRampToValueAtTime(0.001, atTime + dur);
    src.connect(g).connect(ctx.destination);
    src.start(atTime);
  }

  // ====== –ú—É–∑—ã–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∞–ª—é—Ç–∞ (HTMLAudio) ======
  const finalSong = document.getElementById('finalSong');
  finalSong.volume = 0.85;
  let songPrimed = false;

  function primeFinalSong(){
    if (songPrimed) return;
    try {
      finalSong.muted = true;
      finalSong.play().then(() => {
        finalSong.pause();
        finalSong.muted = false;
        finalSong.currentTime = 0;
        songPrimed = true;
      }).catch(() => {});
    } catch(e) {}
  }
  function playFinalSong(){
    if (!audioEnabled) return;
    try { finalSong.currentTime = 0; finalSong.play().catch(() => {}); } catch(e) {}
  }
  function stopFinalSong(){
    try { finalSong.pause(); } catch(e) {}
  }

  // ====== –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å–∞–ª—é—Ç (Canvas) ======
  const canvas = document.getElementById('fx');
  const back = document.getElementById('fxBack');
  const ctx2d = canvas.getContext('2d');
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  function resizeCanvas(){
    const w = window.innerWidth, h = window.innerHeight;
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx2d.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', resizeCanvas, { passive:true });
  resizeCanvas();

  const GRAVITY = 90;
  const AIR = 0.995;

  class Particle{
    constructor(x, y, angle, speed, color){
      this.x=x; this.y=y;
      this.vx=Math.cos(angle)*speed;
      this.vy=Math.sin(angle)*speed;
      this.alpha=1;
      this.life = 0.9 + Math.random()*0.6;
      this.color=color;
      this.size=1.4 + Math.random()*2.2;
      this.spark = Math.random() < 0.2;
    }
    update(dt){
      this.vy += GRAVITY * dt;
      this.vx *= AIR; this.vy *= AIR;
      this.x += this.vx * dt; this.y += this.vy * dt;
      this.alpha -= dt / this.life;
    }
    draw(ctx){
      if (this.alpha <= 0) return;
      ctx.globalAlpha = Math.max(0, this.alpha);
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
      ctx.fillStyle = this.color;
      ctx.fill();
      if (this.spark && Math.random() < 0.4){
        ctx.globalAlpha = Math.max(0, this.alpha*0.7);
        ctx.fillRect(this.x + (Math.random()-0.5)*6, this.y + (Math.random()-0.5)*6, 1.2, 1.2);
      }
      ctx.globalAlpha = 1;
    }
  }

  class Rocket{
    constructor(w, h){
      this.x = w*0.1 + Math.random()*w*0.8;
      this.y = h + 12;
      this.vx = (Math.random()-0.5)*40;
      this.vy = -(260 + Math.random()*220);
      this.targetY = h * (0.22 + Math.random()*0.4);
      this.exploded = false;
      this.trail = [];
      this.hue = Math.floor(Math.random()*360);
      this.color = `hsl(${this.hue} 100% 65%)`;
      this.swishPlayed = false;
    }
    update(dt){
      if (this.exploded) return;
      this.vy += 120 * dt;
      this.x += this.vx * dt; this.y += this.vy * dt;
      this.trail.push({x:this.x, y:this.y, a:1});
      if (this.trail.length > 12) this.trail.shift();
      if (!this.swishPlayed){ playWhistle(0.9); this.swishPlayed = true; }
      if (this.vy > -40 || this.y <= this.targetY){ this.explode(); }
    }
    explode(){
      if (this.exploded) return;
      this.exploded = true;

      const count = 120 + Math.floor(Math.random()*80);
      for (let i=0;i<count;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 90 + Math.random()*260;
        fireworks.particles.push(new Particle(this.x, this.y, angle, speed, this.color));
      }
      for (let i=0;i<30;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 40 + Math.random()*80;
        fireworks.particles.push(new Particle(this.x, this.y, angle, speed, '#fff7d6'));
      }
      playExplosion();
    }
    draw(ctx){
      if (this.exploded) return;
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 2;
      ctx.globalAlpha = .7;
      ctx.beginPath();
      for (let i=0;i<this.trail.length;i++){
        const t = this.trail[i];
        i===0 ? ctx.moveTo(t.x, t.y) : ctx.lineTo(t.x, t.y);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(this.x, this.y, 2.2, 0, Math.PI*2);
      ctx.fillStyle=this.color;
      ctx.fill();
    }
  }

  const fireworks = {
    running:false,
    rockets:[],
    particles:[],
    last:0,
    endAt:0,
    _failsafe: null,
    start(durationMs=10000){
      if (this.running) this.stop();
      this.running = true;
      back.classList.add('show');
      canvas.classList.add('show');
      this.last = performance.now();
      this.endAt = (Number.isFinite(durationMs) ? this.last + durationMs : Infinity);

      if (Number.isFinite(durationMs)) {
        this._failsafe = setTimeout(() => { if (this.running) this.stop(); }, durationMs + 2000);
      } else {
        this._failsafe = null;
      }
      this.loop();
    },
    stop(){
      this.running = false;
      if (this._failsafe){ clearTimeout(this._failsafe); this._failsafe = null; }
      this.rockets.length = 0;
      this.particles.length = 0;
      back.classList.remove('show');
      canvas.classList.remove('show');
      ctx2d.clearRect(0,0,window.innerWidth, window.innerHeight);
    },
    spawnRocket(){
      this.rockets.push(new Rocket(window.innerWidth, window.innerHeight));
    },
    loop(){
      if (!this.running) return;
      const now = performance.now();
      const dt = Math.min((now - this.last) / 1000, 0.035);
      this.last = now;

      const cw = window.innerWidth, ch = window.innerHeight;

      ctx2d.fillStyle = 'rgba(0,0,0,.20)';
      ctx2d.fillRect(0,0,cw,ch);

      if (now < this.endAt) {
        if (Math.random() < 0.14) this.spawnRocket();
      }

      for (const r of this.rockets) { r.update(dt); r.draw(ctx2d); }
      this.rockets = this.rockets.filter(r => !r.exploded);

      ctx2d.globalCompositeOperation = 'lighter';
      for (const p of this.particles) { p.update(dt); p.draw(ctx2d); }
      ctx2d.globalCompositeOperation = 'source-over';
      this.particles = this.particles.filter(p => p.alpha > 0 && p.y < ch + 80);

      if (now >= this.endAt && this.rockets.length === 0 && this.particles.length === 0) {
        this.stop(); return;
      }
      requestAnimationFrame(this.loop.bind(this));
    }
  };

  function triggerFireworks(ms){ fireworks.start(ms || 10_000); }

  const soundBtn = document.getElementById('soundBtn');
  soundBtn.addEventListener('click', async () => {
    if (!audioCtx) ensureAudio();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    audioEnabled = !audioEnabled;

    soundBtn.setAttribute('aria-pressed', String(audioEnabled));
    soundBtn.textContent = audioEnabled ? 'üîä –ó–≤—É–∫ –≤–∫–ª.' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª.';

    if (audioEnabled){
      primeFinalSong();
      if (endedFired) playFinalSong();
    } else {
      stopFinalSong();
    }
  });

  // ====== –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å "–∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Üí –æ–π ‚Üí –∫–∞—Ä—Ç–∏–Ω–∫–∞" ======
  const overlay = document.getElementById('overlay');
  const ovImg1  = document.getElementById('ovImg1');
  const ovImg2  = document.getElementById('ovImg2');
  const ovText  = document.getElementById('ovText');

  function endSequence(){
    const showOnly = (el) => {
      ovImg1.classList.remove('visible');
      ovImg2.classList.remove('visible');
      ovText.classList.remove('visible');
      if (el) el.classList.add('visible');
    };

    overlay.classList.add('show');

    if (audioEnabled) playFinalSong();

    showOnly(ovImg1);
    setTimeout(() => { showOnly(null); }, 1400);

    setTimeout(() => { showOnly(ovText); }, 1600);
    setTimeout(() => { showOnly(null); }, 3000);

    setTimeout(() => { showOnly(ovImg2); }, 3200);
  }

  // ====== –°–ù–ï–ì (–æ—Ç–¥–µ–ª—å–Ω—ã–π canvas, –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω) ======
  const snow = document.getElementById('snow');
  const sctx = snow.getContext('2d');
  const SDPR = Math.min(window.devicePixelRatio || 1, 2);

  let flakes = [];
  let sLast = performance.now();

  function resizeSnow(){
    const w = window.innerWidth, h = window.innerHeight;
    snow.width = Math.floor(w * SDPR);
    snow.height = Math.floor(h * SDPR);
    snow.style.width = w + 'px';
    snow.style.height = h + 'px';
    sctx.setTransform(SDPR, 0, 0, SDPR, 0, 0);
    initFlakes();
  }

  function initFlakes(){
    const w = window.innerWidth, h = window.innerHeight;
    const count = Math.round(Math.min(200, Math.max(80, w / 8)));
    flakes = Array.from({ length: count }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: 0.8 + Math.random() * 2.6,
      v: 18 + Math.random() * 70,
      drift: (Math.random() * 2 - 1) * 22,
      wobble: Math.random() * Math.PI * 2,
      a: 0.22 + Math.random() * 0.65
    }));
  }

  function snowLoop(now){
    const w = window.innerWidth, h = window.innerHeight;
    const dt = Math.min((now - sLast) / 1000, 0.033);
    sLast = now;

    sctx.clearRect(0, 0, w, h);

    for (const f of flakes){
      f.wobble += dt * (0.9 + Math.random() * 0.2);
      f.x += (f.drift + Math.sin(f.wobble) * 12) * dt;
      f.y += f.v * dt;

      if (f.y > h + 12){ f.y = -12; f.x = Math.random() * w; }
      if (f.x < -30) f.x = w + 30;
      if (f.x > w + 30) f.x = -30;

      sctx.globalAlpha = f.a;
      sctx.beginPath();
      sctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      sctx.fillStyle = '#ffffff';
      sctx.fill();
    }
    sctx.globalAlpha = 1;

    requestAnimationFrame(snowLoop);
  }

  window.addEventListener('resize', resizeSnow, { passive: true });
  resizeSnow();
  requestAnimationFrame(snowLoop);

})();
</script>
</body>
</html>
