<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–¢–∞–π–º–µ—Ä –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –º–æ–µ–π –ª—é–±–∏–º–æ–π –¥–µ–≤–æ—á–∫–∏</title>

    <style>
        :root {
            --bg1: #060b16;
            --bg2: #0b1630;
            --card: #0f1c33cc;
            --edge: #1a2b4e;
            --text: #eaf2ff;
            --muted: #9fb0d6;
            --accent: #70b8ff;
            --glow: 0 0 10px rgba(112,184,255,.35), 0 0 24px rgba(112,184,255,.18);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
            color: var(--text);
            overflow-x: hidden;
            background: radial-gradient(1200px 700px at 20% 10%, rgba(120,170,255,.18), transparent 55%), radial-gradient(900px 600px at 80% 25%, rgba(255,143,182,.14), transparent 55%), linear-gradient(180deg, var(--bg1), var(--bg2));
        }

        /* subtle stars */
        .stars {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.7) 50%, transparent 52%), radial-gradient(1px 1px at 25% 35%, rgba(255,255,255,.55) 50%, transparent 52%), radial-gradient(2px 2px at 40% 15%, rgba(255,255,255,.5) 50%, transparent 52%), radial-gradient(1px 1px at 55% 30%, rgba(255,255,255,.6) 50%, transparent 52%), radial-gradient(2px 2px at 70% 18%, rgba(255,255,255,.55) 50%, transparent 52%), radial-gradient(1px 1px at 85% 28%, rgba(255,255,255,.45) 50%, transparent 52%), radial-gradient(2px 2px at 92% 12%, rgba(255,255,255,.6) 50%, transparent 52%);
            opacity: .55;
            mix-blend-mode: screen;
        }

        
/* top garland */
.garland{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 120px;
    z-index: 20;
    pointer-events: none;
    filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
}
.garland svg{
    width: 100%;
    height: 100%;
    display: block;
}

.wire{ fill:none; stroke-linecap:round; stroke-linejoin:round; }
.wire-back{ stroke: rgba(0,0,0,.38); stroke-width: 9; opacity:.55; filter: blur(.25px); }
.wire-front{ stroke: rgba(20,40,75,.95); stroke-width: 6.2; }
.wire-shine{ stroke: rgba(210,230,255,.18); stroke-width: 2.2; opacity:.7; }

/* bulbs built as <g class="g-bulb"> ... */
.g-bulb{
    /* positioned by SVG transform attribute (translate along the wire) */
}

.g-bulbPulse{
    transform-box: fill-box;
    transform-origin: center;
    animation: garlandPulse var(--dur, 3.2s) ease-in-out infinite;
    animation-delay: var(--delay, 0s);
}

.g-drop{ fill:none; stroke: rgba(24,44,82,.92); stroke-width: 2.3; stroke-linecap: round; opacity: .92; }
.g-drop-glow{ stroke: rgba(112,184,255,.18); stroke-width: 4.4; opacity: .75; filter: blur(.25px); }

.g-cap{ fill: rgba(28,44,76,.98); }
.g-neck{ fill: rgba(18,30,56,.98); opacity: .95; }
.g-glass{
    fill: var(--fill);
    stroke: rgba(255,255,255,.22);
    stroke-width: 1.4;
    filter: drop-shadow(0 0 12px var(--glow)) drop-shadow(0 10px 16px rgba(0,0,0,.28));
}
.g-hi{ fill: rgba(255,255,255,.92); opacity: .72; }
.g-shadow{ fill: rgba(0,0,0,.22); opacity: .18; }

@keyframes garlandPulse{
    0%,100%{
        opacity: .78;
        transform: translateY(0) scale(.98);
    }
    50%{
        opacity: 1;
        transform: translateY(-1px) scale(1.05);
    }
}

        /* layout */
        .wrap {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 140px 18px 260px;
            position: relative;
            z-index: 5;
        }

        .card {
            width: min(780px, 100%);
            background: linear-gradient(180deg, rgba(18,30,56,.78), rgba(10,18,36,.58));
            border: 1px solid rgba(120,170,255,.22);
            border-radius: 22px;
            box-shadow: 0 30px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.08);
            backdrop-filter: blur(10px);
            padding: 22px 18px 18px;
            position: relative;
            overflow: hidden;
        }

            .card::before {
                content: "";
                position: absolute;
                inset: -2px;
                background: radial-gradient(700px 220px at 20% 0%, rgba(112,184,255,.18), transparent 60%), radial-gradient(520px 200px at 90% 20%, rgba(255,143,182,.12), transparent 60%);
                pointer-events: none;
            }

        h1 {
            margin: 0 0 8px;
            font-size: clamp(26px, 3.4vw, 40px);
            letter-spacing: .2px;
            text-align: center;
            text-shadow: 0 10px 26px rgba(0,0,0,.35);
        }

        .sub {
            text-align: center;
            margin: 0 0 18px;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.45;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .tile {
            border-radius: 18px;
            border: 1px solid rgba(120,170,255,.18);
            background: rgba(5,10,20,.35);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
            padding: 14px 12px 12px;
            text-align: center;
        }

        .num {
            font-variant-numeric: tabular-nums;
            font-size: clamp(28px, 5vw, 44px);
            font-weight: 800;
            letter-spacing: .6px;
            text-shadow: var(--glow);
        }

        .lbl {
            margin-top: 4px;
            font-size: 13px;
            color: rgba(234,242,255,.78);
            letter-spacing: .2px;
        }

        .footer-note {
            margin-top: 14px;
            text-align: center;
            color: rgba(159,176,214,.9);
            font-size: 12.5px;
        }

        .done {
            margin-top: 14px;
            display: none;
            text-align: center;
            padding: 14px 14px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.07);
            box-shadow: 0 18px 40px rgba(0,0,0,.25);
        }

        /* bottom snow + tree */
        .bottom {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 240px;
            z-index: 10;
            pointer-events: none;
        }

        .snowbanks {
            position: absolute;
            inset: auto 0 0 0;
            height: 190px;
        }

        .bank {
            position: absolute;
            left: -10%;
            width: 120%;
            bottom: -40px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(235,246,255,.88));
            box-shadow: 0 -6px 22px rgba(255,255,255,.10), 0 -24px 60px rgba(112,184,255,.10);
            filter: drop-shadow(0 -10px 30px rgba(0,0,0,.25));
        }

            .bank.bank1 {
                height: 150px;
                opacity: .95;
            }

            .bank.bank2 {
                height: 120px;
                bottom: -55px;
                opacity: .85;
                background: linear-gradient(180deg, rgba(245,252,255,.92), rgba(220,238,255,.80));
                transform: translateX(2%);
            }

            .bank.bank3 {
                height: 105px;
                bottom: -65px;
                opacity: .70;
                background: linear-gradient(180deg, rgba(240,250,255,.85), rgba(200,230,255,.72));
                transform: translateX(-2%);
            }

        .tree-wrap {
            position: absolute;
            left: 50%;
            bottom: 35px;
            transform: translateX(-50%);
            width: 220px;
            height: 260px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: opacity .55s ease, transform .55s ease;
            will-change: opacity, transform;
        }

        .tree-wrap.is-hidden{
            opacity: 0;
            transform: translateX(-50%) translateY(60px) scale(.92);
            pointer-events: none;
        }

        .tree {
            position: relative;
            width: 210px;
            height: 250px;
            filter: drop-shadow(0 24px 30px rgba(0,0,0,.40));
            isolation: isolate; /* –æ—Ç–¥–µ–ª—å–Ω—ã–π stacking context, —á—Ç–æ–±—ã z-index —Ä–∞–±–æ—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–æ */
        }

        .layer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: radial-gradient(140px 80px at 35% 18%, rgba(255,255,255,.22), transparent 62%), linear-gradient(180deg, rgba(22,140,86,1), rgba(6,44,31,1));
            border: 1px solid rgba(255,255,255,.12);
            box-shadow: inset 0 14px 26px rgba(255,255,255,.06), inset 0 -18px 30px rgba(0,0,0,.18);
            clip-path: polygon(50% 0%, 7% 100%, 93% 100%);
            filter: drop-shadow(0 10px 16px rgba(0,0,0,.18));
            z-index: 20;
        }

        /* 5 —è—Ä—É—Å–æ–≤ */
        .l0 {
            bottom: 150px;
            width: 120px;
            height: 72px;
        }

        .l1 {
            bottom: 120px;
            width: 150px;
            height: 80px;
        }

        .l2 {
            bottom: 88px;
            width: 175px;
            height: 88px;
        }

        .l3 {
            bottom: 54px;
            width: 200px;
            height: 98px;
        }

        .l4 {
            bottom: 18px;
            width: 225px;
            height: 114px;
        }

        /* –í–ê–ñ–ù–û: –≤–µ—Ä—Ö–Ω–∏–µ —è—Ä—É—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ù–ê–î –Ω–∏–∂–Ω–∏–º–∏ */
        .l4 {
            z-index: 20;
        }

        .l3 {
            z-index: 30;
        }

        .l2 {
            z-index: 40;
        }

        .l1 {
            z-index: 50;
        }

        .l0 {
            z-index: 60;
        }

        /* 3D-ish silhouette */
        .layer::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(0,0,0,.22), transparent 42%, rgba(255,255,255,.08));
            mix-blend-mode: overlay;
            pointer-events: none;
        }

        .trunk {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            width: 54px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(135,84,44,1), rgba(80,44,20,1));
            border: 1px solid rgba(255,255,255,.10);
            box-shadow: inset 0 10px 18px rgba(255,255,255,.06);
            z-index: 10;
        }

        /* star */
        .star {
            position: absolute;
            left: 50%;
            top: -16px;
            transform: translateX(-50%);
            width: 36px;
            height: 36px;
            background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(255,220,120,.95) 45%, rgba(255,180,60,.9));
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            filter: drop-shadow(0 0 18px rgba(255,215,120,.55)) drop-shadow(0 0 34px rgba(255,140,0,.18));
            animation: starPulse 2.6s ease-in-out infinite;
            z-index: 95;
        }

        @keyframes starPulse {
            0%,100% {
                transform: translateX(-50%) scale(1);
                opacity: .95;
            }

            50% {
                transform: translateX(-50%) scale(1.06);
                opacity: 1;
            }
        }

        /* ornaments (3D balls) */
        .orn {
            position: absolute;
            width: var(--s, 16px);
            height: var(--s, 16px);
            border-radius: 50%;
            z-index: 90;
            opacity: .98;
            border: 1px solid rgba(255,255,255,.22);
            background: radial-gradient(circle at 30% 28%, rgba(255,255,255,.95), rgba(255,255,255,.22) 24%, rgba(255,255,255,0) 46%), radial-gradient(circle at 68% 76%, rgba(0,0,0,.38), rgba(0,0,0,0) 62%), radial-gradient(circle at 52% 56%, rgba(var(--c), .98), rgba(var(--c), .86) 55%, rgba(var(--c), .32) 100%);
            box-shadow: 0 10px 18px rgba(0,0,0,.34), 0 0 18px rgba(var(--c), .20);
            filter: saturate(1.08) contrast(1.03);
            transform: translateZ(0);
            animation: ornBob 4.2s ease-in-out infinite;
            animation-delay: var(--delay, 0s);
        }

            .orn::before {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: 50%;
                background: radial-gradient(circle at 28% 28%, rgba(255,255,255,.95), rgba(255,255,255,0) 55%), radial-gradient(circle at 58% 68%, rgba(255,255,255,.10), rgba(255,255,255,0) 55%);
                mix-blend-mode: screen;
                pointer-events: none;
            }

            .orn::after {
                content: "";
                position: absolute;
                left: 50%;
                top: -12px;
                width: 16px;
                height: 16px;
                transform: translateX(-50%);
                background: linear-gradient(180deg, rgba(230,242,255,.65), rgba(230,242,255,0)) center 0 / 2px 10px no-repeat, linear-gradient(180deg, rgba(245,250,255,.90), rgba(35,55,90,.96)) center 9px / 12px 7px no-repeat, radial-gradient(circle at 50% 77%, rgba(255,255,255,.35), rgba(255,255,255,0) 62%) center 8px / 12px 10px no-repeat;
                opacity: .95;
                pointer-events: none;
                filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
            }

        @keyframes ornBob {
            0%,100% {
                transform: translateY(0) translateZ(0);
            }

            50% {
                transform: translateY(-2px) translateZ(0);
            }
        }

        /* ---- –Å–ª–æ—á–Ω–∞—è –≥–∏—Ä–ª—è–Ω–¥–∞: –æ–±—ä—ë–º–Ω—ã–µ –ª–∞–º–ø–æ—á–∫–∏ (rope lights) ---- */
        .tree-garland {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            opacity: .99;
            overflow: hidden; /* —á—Ç–æ–±—ã –ø—Ä–æ–≤–æ–¥/–ª–∞–º–ø–æ—á–∫–∏ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∏ –∑–∞ –∫–æ–Ω—Ç—É—Ä */
        }

            .tree-garland .cable {
                fill: none;
                stroke: rgba(12,22,45,.92);
                stroke-width: 3.6;
                stroke-linecap: round;
            }

            .tree-garland .cable-glow {
                stroke: rgba(112,184,255,.28);
                stroke-width: 6.2;
                filter: blur(.35px);
            }

            .tree-garland .tg-bulb {
                transform-origin: center;
                filter: drop-shadow(0 0 14px var(--glow));
                animation: tgPulse 2.6s ease-in-out infinite;
                animation-delay: var(--delay, 0s);
            }

            .tree-garland .tg-core {
                fill: var(--fill);
                stroke: rgba(255,255,255,.22);
                stroke-width: 1.4;
            }

            .tree-garland .tg-hi {
                fill: rgba(255,255,255,.88);
                opacity: .85;
            }

            .tree-garland .tg-cap {
                fill: rgba(24,40,70,.96);
                opacity: .95;
            }

        @keyframes tgPulse {
            0%,100% {
                opacity: .75;
                transform: scale(.98);
                filter: drop-shadow(0 0 10px var(--glow));
            }

            50% {
                opacity: 1;
                transform: scale(1.06);
                filter: drop-shadow(0 0 18px var(--glow)) drop-shadow(0 0 28px rgba(255,255,255,.12));
            }
        }

        /* —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –ª–µ–Ω—Ç + –∏—Ö —Å–ª–æ–π–Ω–æ—Å—Ç—å (–∫–∞–∫ –±—É–¥—Ç–æ –æ–±–≤–∏–≤–∞–µ—Ç —ë–ª–∫—É) */
        .g3 {
            top: 142px;
            width: 200px;
            height: 76px;
            z-index: 28;
            clip-path: polygon(50% 0%, 10% 100%, 90% 100%);
        }
        /* –Ω–∏–∂–Ω—è—è –ª–µ–Ω—Ç–∞ (–±–ª–∏–∂–µ –∫ –æ—Å–Ω–æ–≤–∞–Ω–∏—é) */
        .g2 {
            top: 98px;
            width: 170px;
            height: 72px;
            z-index: 46;
            clip-path: polygon(50% 0%, 14% 100%, 86% 100%);
        }
        /* —Å—Ä–µ–¥–Ω—è—è –ª–µ–Ω—Ç–∞ */
        .g1 {
            top: 58px;
            width: 140px;
            height: 70px;
            z-index: 56;
            clip-path: polygon(50% 0%, 20% 100%, 80% 100%);
        }
        /* –≤–µ—Ä—Ö–Ω—è—è –ª–µ–Ω—Ç–∞ */

        /* snow canvas */
        #snow {
            position: fixed;
            inset: 0;
            z-index: 15;
            pointer-events: none;
        }

        /* responsive */
        @media (max-width: 640px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .wrap {
                padding: 130px 14px 270px;
            }

            .tree-wrap {
                transform: translateX(-50%) scale(.9);
            }
        }

        /* reduce motion */
        @media (prefers-reduced-motion: reduce) {
            .g-bulb, .star {
                animation: none !important;
            }

            .tree-garland .tg-bulb,
            .orn {
                animation: none !important;
            }

            #snow {
                display: none;
            }
        }
    
        /* ===== Day-change WOW effects ===== */
        #fx{
            position: fixed;
            inset: 0;
            z-index: 19; /* above snow, below garland (20) */
            pointer-events: none;
        }

        .day-pulse{
            animation: dayPulse .65s cubic-bezier(.2,.9,.2,1) 1;
        }
        @keyframes dayPulse{
            0%   { transform: translateY(0) scale(1);   filter: brightness(1); }
            18%  { transform: translateY(-3px) scale(1.015); filter: brightness(1.22); }
            55%  { transform: translateY(1px)  scale(1.006); filter: brightness(1.10); }
            100% { transform: translateY(0) scale(1);   filter: brightness(1); }
        }

        .toast{
            position: fixed;
            left: 50%;
            top: 138px;
            transform: translateX(-50%);
            z-index: 40;
            padding: 10px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.16);
            background: linear-gradient(180deg, rgba(14,24,46,.78), rgba(10,18,36,.58));
            box-shadow: 0 18px 50px rgba(0,0,0,.45);
            backdrop-filter: blur(12px);
            color: rgba(234,242,255,.96);
            font-size: 13px;
            letter-spacing: .2px;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
        }
        .toast.show{
            animation: toastInOut 1.9s cubic-bezier(.2,.9,.2,1) 1;
        }
        @keyframes toastInOut{
            0%{ opacity: 0; transform: translateX(-50%) translateY(-10px) scale(.98); filter: blur(.4px); }
            16%{ opacity: 1; transform: translateX(-50%) translateY(0) scale(1); filter: blur(0); }
            84%{ opacity: 1; }
            100%{ opacity: 0; transform: translateX(-50%) translateY(-10px) scale(.985); filter: blur(.4px); }
        }

        /* Party mode: briefly speed up garlands + extra glow */
        body.party .garland{
            filter: drop-shadow(0 14px 30px rgba(0,0,0,.35)) drop-shadow(0 0 20px rgba(112,184,255,.18));
        }
        body.party .garland .wire-shine{ opacity: .95; }
        body.party .garland .g-bulbPulse{
            animation-duration: 1.0s !important;
            filter: drop-shadow(0 0 14px var(--glow, rgba(112,184,255,.45)));
        }

        .tree-garland.tg-fast .tg-bulb{
            animation-duration: .85s;
            filter: drop-shadow(0 0 18px var(--glow));
        }

        .star.sparkle{
            animation: starSpark 1.1s ease-out 1;
        }
        @keyframes starSpark{
            0%{ transform: translateX(-50%) scale(1); filter: drop-shadow(0 0 18px rgba(255,215,120,.55)) drop-shadow(0 0 34px rgba(255,140,0,.18)); }
            25%{ transform: translateX(-50%) scale(1.18) rotate(-2deg); filter: drop-shadow(0 0 28px rgba(255,240,180,.78)) drop-shadow(0 0 60px rgba(255,180,60,.24)); }
            100%{ transform: translateX(-50%) scale(1); }
        }

        /* Aurora sweep (day-change) */
        .aurora{
            position: fixed;
            inset: -20% -10%;
            z-index: 12;
            pointer-events: none;
            opacity: 0;
            filter: blur(18px) saturate(1.15);
            transform: translate3d(0,0,0);
            background:
                radial-gradient(40% 35% at 20% 35%, rgba(120,255,190,.30), transparent 60%),
                radial-gradient(40% 35% at 55% 30%, rgba(120,180,255,.28), transparent 62%),
                radial-gradient(45% 40% at 80% 42%, rgba(255,140,200,.22), transparent 62%);
            mix-blend-mode: screen;
        }
        .aurora.on{
            animation: auroraSweep 1.7s cubic-bezier(.2,.9,.2,1) 1;
        }
        @keyframes auroraSweep{
            0%{ opacity: 0; transform: translateY(-6%) translateX(-3%) scale(1.02) skewX(-2deg); }
            18%{ opacity: .95; }
            55%{ opacity: .55; transform: translateY(2%) translateX(2%) scale(1.06) skewX(2deg); }
            100%{ opacity: 0; transform: translateY(6%) translateX(6%) scale(1.08) skewX(3deg); }
        }

        @media (max-width: 640px){
            .toast{ top: 120px; font-size: 12.5px; }
        }

    
/* sound toggle */
.soundToggle{
  position: fixed;
  top: 18px;
  right: 18px;
  z-index: 40;
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(10,18,36,.55);
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
  color: rgba(234,242,255,.95);
  display: grid;
  place-items: center;
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  transition: transform .15s ease, filter .2s ease;
}
.soundToggle:hover{ transform: translateY(-1px); filter: brightness(1.08); }
.soundToggle:active{ transform: translateY(0); filter: brightness(.98); }
.soundToggle:focus-visible{ outline: 2px solid rgba(112,184,255,.6); outline-offset: 3px; }


        /* ===== Finale: —Ç–∞–π–º–µ—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ç–æ –∏ —É–µ–∑–∂–∞–µ—Ç –≤ –≤–∞–≥–æ–Ω—á–∏–∫–µ ===== */
        .photo{
            position: fixed;
            left: 0; top: 0;
            width: 320px;
            height: 200px;
            z-index: 55;
            display: none;
            pointer-events: none;
            transform-origin: center;
        }
        .photo .photo-frame{
            width: 100%;
            height: 100%;
            border-radius: 22px;
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(225,238,255,.86));
            padding: 10px;
            box-shadow: 0 26px 80px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.22) inset;
            filter: drop-shadow(0 0 20px rgba(112,184,255,.10));
        }
        .photo .photo-shot{
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            border: 1px solid rgba(120,170,255,.22);
            background: linear-gradient(180deg, rgba(18,30,56,.92), rgba(10,18,36,.72));
            box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 14px;
        }

        .photo .photo-img{
            position: absolute;
            inset: 0;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            opacity: 0;
            transform: scale(1.04);
            transition: opacity 280ms ease, transform 650ms ease;
            z-index: 0;
        }
        .photo .photo-shot::after{
            /* –ª—ë–≥–∫–∞—è –∑–∞—Ç–µ–º–Ω—è—é—â–∞—è –ø–ª—ë–Ω–∫–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã "—á–∏—Ç–∞–ª–æ—Å—å" –≤ –æ–∫–Ω–µ –≤–∞–≥–æ–Ω–∞ */
            content:"";
            position:absolute;
            inset:0;
            background: radial-gradient(120% 100% at 50% 30%, rgba(255,255,255,.08), rgba(0,0,0,.55));
            opacity: 0;
            transition: opacity 280ms ease;
            z-index: 1;
            pointer-events: none;
        }
            .photo .photo-shot > :not(.photo-img) {
                position: relative;
                z-index: 2;
            }

            /* –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∑–∞–∫—Ä–µ–ø–∏–º —Å–ª–æ—é —Ñ–æ—Ç–æ absolute –∏ –Ω–∏–∂–Ω–∏–π z-index */
            .photo .photo-img {
                position: absolute;
                inset: 0;
                z-index: 0;
            }

        .photo.is-image .photo-img{ opacity: 1; transform: scale(1); }
        .photo.is-image .photo-shot::after{ opacity: 1; }

        .photo.is-image .photo-title,
        .photo.is-image .photo-time,
        .photo.is-image .photo-caption{
            opacity: 0;
            transform: translateY(10px);
            filter: blur(2px);
            transition: opacity 220ms ease, transform 220ms ease, filter 220ms ease;
        }

        .photo .photo-title{
            text-align: center;
            color: rgba(234,242,255,.95);
            font-size: 13px;
            letter-spacing: .2px;
            text-shadow: 0 10px 26px rgba(0,0,0,.35);
        }
        .photo .photo-time{
            font-variant-numeric: tabular-nums;
            font-weight: 900;
            letter-spacing: .5px;
            font-size: clamp(20px, 3.5vw, 34px);
            text-shadow: var(--glow);
        }
        .photo .photo-caption{
            color: rgba(159,176,214,.95);
            font-size: 12.5px;
            letter-spacing: .2px;
        }

        /* train scene */
        
        /* ===== Train Ride Parallax (camera follows the train) ===== */
        .ride-scene{
            position: fixed;
            left: 0; right: 0;
            bottom: 92px; /* align with train-scene */
            height: 260px;
            z-index: 17; /* behind train (18), above snow (15) */
            pointer-events: none;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: opacity .35s ease, visibility .35s ease;
        }
        body.ride .ride-scene{
            opacity: 1;
            visibility: visible;
        }
        .ride-vignette{
            position:absolute;
            inset: -10px;
            background:
                radial-gradient(120% 90% at 50% 105%, rgba(0,0,0,.36), transparent 55%),
                radial-gradient(80% 70% at 50% 35%, rgba(0,0,0,.20), transparent 60%);
            mix-blend-mode: multiply;
            opacity: .65;
        }
        .ride-layer{
            position: absolute;
            left: -10vw;
            right: -10vw;
            bottom: 0;
            background-repeat: repeat-x;
            background-position: 0 100%;
            will-change: background-position;
        }
        .ride-layer.far{
            top: 10px;
            height: 170px;
            opacity: .74;
            filter: blur(.25px);
            --tile: 560;
            --speed: 9.0;
            background-size: calc(var(--tile) * 1px) 170px;
            background-image:
                radial-gradient(220px 120px at 120px 155px, rgba(17,33,63,.92) 58%, transparent 60%),
                radial-gradient(190px 110px at 320px 160px, rgba(14,28,54,.90) 58%, transparent 60%),
                radial-gradient(250px 140px at 520px 158px, rgba(12,24,46,.88) 58%, transparent 60%),
                radial-gradient(2px 2px at 85px 28px, rgba(255,255,255,.22) 50%, transparent 55%),
                radial-gradient(1.5px 1.5px at 240px 36px, rgba(255,255,255,.18) 50%, transparent 55%),
                radial-gradient(1.6px 1.6px at 460px 22px, rgba(255,255,255,.16) 50%, transparent 55%),
                linear-gradient(180deg, rgba(0,0,0,0) 0 45%, rgba(0,0,0,.18) 100%);
        }
        .ride-layer.mid{
            top: 58px;
            height: 190px;
            opacity: .88;
            --tile: 420;
            --speed: 18.0;
            background-size: calc(var(--tile) * 1px) 190px;
            background-image:
                radial-gradient(70px 42px at 70px 176px, rgba(6,16,28,.92) 60%, transparent 62%),
                radial-gradient(80px 50px at 180px 182px, rgba(7,18,32,.93) 60%, transparent 62%),
                radial-gradient(62px 40px at 300px 174px, rgba(6,16,28,.92) 60%, transparent 62%),
                radial-gradient(96px 56px at 390px 186px, rgba(7,18,32,.93) 60%, transparent 62%),
                radial-gradient(55px 34px at 16px 182px, rgba(6,16,28,.90) 60%, transparent 62%),
                linear-gradient(180deg, rgba(0,0,0,0) 0 56%, rgba(5,12,22,.74) 58% 100%);
        }
        .ride-layer.near{
            left: -22vw;
            right: -22vw;
            bottom: -6px;
            height: 96px;
            opacity: .55;
            filter: blur(1px);
            --tile: 280;
            --speed: 38.0;
            background-size: calc(var(--tile) * 1px) 96px;
            background-image:
                linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0) 56%),
                repeating-linear-gradient(90deg,
                    rgba(255,255,255,.10) 0 10px,
                    rgba(255,255,255,0) 10px 30px
                );
        }
        .ride-flybys{
            position:absolute;
            inset: 0;
            z-index: 3;
            overflow: hidden;
        }
        .flyby{
            position:absolute;
            bottom: 0;
            left: 0;
            transform-origin: 50% 100%;
            will-change: transform, opacity;
            filter: blur(var(--blur, 0px));
            animation: flybyMove var(--dur, 2600ms) linear forwards;
        }
        @keyframes flybyMove{
            0%{ transform: translateX(var(--fromX, 110vw)) scale(var(--scale, 1)); opacity: 0; }
            8%{ opacity: 1; }
            100%{ transform: translateX(var(--toX, -15vw)) scale(var(--scale, 1)); opacity: .98; }
        }
        /* Trees */
        .flyby.tree{
            width: 86px;
            height: 170px;
        }
        .flyby.tree .trunk{
            position:absolute;
            left: 50%;
            bottom: 0;
            width: 12px;
            height: 30px;
            transform: translateX(-50%);
            border-radius: 0 0 8px 8px;
            background: linear-gradient(180deg, rgba(120,86,46,.95), rgba(80,54,28,.95));
            box-shadow: 0 10px 18px rgba(0,0,0,.28);
        }
        .flyby.tree .canopy{
            position:absolute;
            left: 50%;
            width: 0;
            height: 0;
            transform: translateX(-50%);
            filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
        }
        .flyby.tree .c1{
            bottom: 22px;
            border-left: 38px solid transparent;
            border-right: 38px solid transparent;
            border-bottom: 82px solid rgba(16,64,42,.98);
        }
        .flyby.tree .c2{
            bottom: 56px;
            border-left: 32px solid transparent;
            border-right: 32px solid transparent;
            border-bottom: 70px solid rgba(14,58,38,.96);
            opacity: .98;
        }
        .flyby.tree .c3{
            bottom: 84px;
            border-left: 26px solid transparent;
            border-right: 26px solid transparent;
            border-bottom: 56px solid rgba(12,50,34,.95);
            opacity: .95;
        }
        /* Lamps */
        .flyby.lamp{
            width: 86px;
            height: 190px;
        }
        .flyby.lamp .post{
            position:absolute;
            left: 50%;
            bottom: 0;
            width: 10px;
            height: 140px;
            transform: translateX(-50%);
            border-radius: 8px;
            background: linear-gradient(180deg, rgba(190,200,220,.70), rgba(60,70,95,.85));
            box-shadow: 0 12px 22px rgba(0,0,0,.30);
        }
        .flyby.lamp .arm{
            position:absolute;
            left: 50%;
            bottom: 118px;
            width: 46px;
            height: 8px;
            transform: translateX(-2px) rotate(-6deg);
            border-radius: 10px;
            background: linear-gradient(90deg, rgba(190,200,220,.60), rgba(60,70,95,.88));
        }
        .flyby.lamp .head{
            position:absolute;
            left: 50%;
            bottom: 108px;
            width: 18px;
            height: 14px;
            transform: translateX(24px);
            border-radius: 0 0 10px 10px;
            background: rgba(245,225,165,.98);
            box-shadow: 0 0 18px rgba(255,220,120,.55), 0 0 46px rgba(255,220,120,.25);
        }
        .flyby.lamp .glow{
            position:absolute;
            left: 50%;
            bottom: 70px;
            width: 92px;
            height: 92px;
            transform: translateX(28px);
            background: radial-gradient(circle at 50% 25%, rgba(255,230,160,.55), transparent 62%);
            filter: blur(2px);
            opacity: .95;
        }

        /* Train ride subtle camera feel */
        body.ride .train{
            animation: trainBob 1.15s ease-in-out infinite;
        }
        @keyframes trainBob{
            0%,100%{ transform: translateX(-50%) translateY(0px); }
            50%{ transform: translateX(-50%) translateY(-1.8px); }
        }

        /* Photo inside train window */
        .photo.in-seat{
            display:block !important;
            position:absolute !important;
            left:0 !important;
            top:0 !important;
            width:100% !important;
            height:100% !important;
            transform:none !important;
            border-radius: 10px !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        .photo.in-seat .photo-title,
        .photo.in-seat .photo-time,
        .photo.in-seat .photo-caption{
            display:none !important;
        }
        .photo.in-seat .photo-frame{
            position:absolute;
            inset: 0;
            border-radius: 10px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
            overflow:hidden;
        }
        .photo.in-seat .photo-shot{
            border-radius: 10px;
        }
        .photo.in-seat .photo-img{
            position:absolute;
            inset: 0;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            filter: none;
        }

        @media (max-width: 640px){
            .ride-scene{ height: 240px; }
            .flyby.tree{ width: 76px; height: 150px; }
            .flyby.lamp{ width: 76px; height: 175px; }
        }

        @media (prefers-reduced-motion: reduce){
            .ride-scene{ display:none !important; }
            body.ride .train{ animation: none !important; }
        }


        .train-scene{
            position: fixed;
            left: 0; right: 0;
            bottom: 92px; /* –Ω–∞–¥ —Å—É–≥—Ä–æ–±–∞–º–∏ */
            height: 104px;
            z-index: 18; /* –Ω–∞–¥ —Å–Ω–µ–≥–æ–º/—ë–ª–∫–æ–π, –ø–æ–¥ –≤–µ—Ä—Ö–Ω–µ–π –≥–∏—Ä–ª—è–Ω–¥–æ–π */
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity .25s ease, visibility .25s ease;
        }
        body.finale .train-scene{
            opacity: 1;
            visibility: visible;
        }
        .train-scene .track{
            position: absolute;
            left: -5%;
            right: -5%;
            bottom: 8px;
            height: 10px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.05));
            box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06) inset;
            opacity: .7;
        }
        .train{
            position: absolute;
            left: 50%;
            bottom: 0;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            transform: translateX(-180%);
            opacity: 0;
            will-change: transform, opacity;
            filter: drop-shadow(0 22px 26px rgba(0,0,0,.38));
        }
        .train .engine,
        .train .wagon{
            position: relative;
            height: 70px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,.14);
            background: linear-gradient(180deg, rgba(20,40,75,.92), rgba(10,18,36,.92));
            box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
            overflow: hidden;
        }
        .train .engine{
            width: 170px;
            border-radius: 20px 18px 18px 20px;
        }
        .train .engine::before{
            content:"";
            position:absolute;
            left: 12px; top: 10px;
            width: 50px; height: 30px;
            border-radius: 10px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
        }
        .train .chimney{
            position:absolute;
            left: 22px;
            top: -14px;
            width: 22px;
            height: 26px;
            border-radius: 8px 8px 10px 10px;
            background: linear-gradient(180deg, rgba(35,55,90,.98), rgba(12,20,40,.98));
            border: 1px solid rgba(255,255,255,.12);
        }
        .train .nose{
            position:absolute;
            right: -18px;
            bottom: 10px;
            width: 40px;
            height: 40px;
            border-radius: 18px;
            background: linear-gradient(180deg, rgba(120,170,255,.30), rgba(120,170,255,.06));
            border: 1px solid rgba(255,255,255,.10);
            transform: rotate(12deg);
        }
        .train .headlight{
            position:absolute;
            right: 10px;
            top: 20px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.95), rgba(255,220,120,.92) 55%, rgba(255,180,60,.10));
            box-shadow: 0 0 24px rgba(255,220,120,.35);
        }

        .train .wagon{
            width: 190px;
        }
        .train .stripe{
            position:absolute;
            left: -20%;
            right: -20%;
            top: 36px;
            height: 10px;
            background: linear-gradient(90deg, rgba(112,184,255,.0), rgba(112,184,255,.22), rgba(255,143,182,.18), rgba(112,184,255,.0));
            opacity: .8;
            transform: skewX(-12deg);
        }

        .train .window{
            position:absolute;
            top: 14px;
            width: 48px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.14);
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.15), rgba(10,18,36,.90));
            box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
            overflow: hidden;
        }
        .train .window.w1{ left: 16px; }
        .train .window.w2{ left: 74px; }
        .train .window.w3{ left: 132px; }
        .train .window.seat{
            outline: 2px solid rgba(112,184,255,.20);
            outline-offset: -2px;
        }

        .train .door{
            position:absolute;
            right: 12px;
            top: 12px;
            width: 32px;
            height: 46px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.05);
        }

        .train .wheels{
            position:absolute;
            left: 14px;
            right: 14px;
            bottom: -10px;
            display:flex;
            justify-content: space-between;
            align-items:center;
            gap: 10px;
            pointer-events:none;
        }
        .train .wheel{
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,.18);
            background:
                radial-gradient(circle at 35% 35%, rgba(255,255,255,.30), rgba(255,255,255,0) 45%),
                radial-gradient(circle at 50% 50%, rgba(0,0,0,.35), rgba(0,0,0,0) 55%),
                linear-gradient(180deg, rgba(35,55,90,.96), rgba(12,20,40,.96));
            box-shadow: 0 10px 20px rgba(0,0,0,.35);
        }
        .train.moving .wheel{
            animation: wheelSpin .55s linear infinite;
        }
        @keyframes wheelSpin{
            to{ transform: rotate(360deg); }
        }

        .train .smoke{
            position:absolute;
            left: 18px;
            top: -34px;
            width: 120px;
            height: 50px;
            overflow: visible;
            pointer-events:none;
        }
        .train .puff{
            position:absolute;
            left: 0;
            top: 20px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255,255,255,.22);
            filter: blur(.2px);
            opacity: 0;
        }
        .train.moving .puff{
            animation: puff 1.4s ease-out infinite;
        }
        .train.moving .puff:nth-child(2){ animation-delay: .35s; left: 16px; }
        .train.moving .puff:nth-child(3){ animation-delay: .70s; left: 32px; }
        @keyframes puff{
            0%{ transform: translate(0,0) scale(.9); opacity: 0; }
            10%{ opacity: .55; }
            100%{ transform: translate(70px,-34px) scale(1.65); opacity: 0; }
        }

        /* hide the timer card visually during finale (photo takes over) */
        body.finale .card{ pointer-events: none; }


        .photo-picker{
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 9999;
            border: 1px solid rgba(120,170,255,.28);
            background: rgba(15,28,51,.78);
            color: var(--text);
            border-radius: 14px;
            padding: 10px 12px;
            cursor: pointer;
            box-shadow: 0 18px 50px rgba(0,0,0,.35);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .photo-picker:hover{ transform: translateY(-1px); }

</style>
</head>

<body>
    <canvas id="snow" aria-hidden="true"></canvas>
    <canvas id="fx" aria-hidden="true"></canvas>
    <div class="aurora" aria-hidden="true"></div>
    <div class="stars" aria-hidden="true"></div>

    <!-- Garland -->
    <div class="garland" aria-hidden="true">
        <svg viewBox="0 0 1000 120" preserveAspectRatio="none">
            <!-- wire (3 layers for depth) -->
            <path id="wirePath" class="wire wire-back" d="M0,46 C200,112 310,6 500,62 C690,118 800,6 1000,46" />
            <path class="wire wire-front" d="M0,46 C200,112 310,6 500,62 C690,118 800,6 1000,46" />
            <path class="wire wire-shine" d="M0,46 C200,112 310,6 500,62 C690,118 800,6 1000,46" />
            <g id="bulbs"></g>
        </svg>
    </div>

    <button id="soundToggle" class="soundToggle" type="button" aria-label="–ó–≤—É–∫" aria-pressed="true" title="–ó–≤—É–∫">üîä</button>
    <main class="wrap">
        <section class="card" role="group" aria-label="–¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞ –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –º–æ–µ–π –∫—Ä–∞—Å–æ—Ç–∫–∏">
            <h1>–¢–∞–π–º–µ—Ä –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –º–æ–µ–π –ª—é–±–∏–º–æ–π –¥–µ–≤–æ—á–∫–∏</h1>
            <p class="sub"><br></p>

            <div class="grid" aria-live="polite">
                <div class="tile">
                    <div class="num" id="d">‚Äî</div>
                    <div class="lbl">–¥–Ω–µ–π</div>
                </div>
                <div class="tile">
                    <div class="num" id="h">‚Äî</div>
                    <div class="lbl">—á–∞—Å–æ–≤</div>
                </div>
                <div class="tile">
                    <div class="num" id="m">‚Äî</div>
                    <div class="lbl">–º–∏–Ω—É—Ç</div>
                </div>
                <div class="tile">
                    <div class="num" id="s">‚Äî</div>
                    <div class="lbl">—Å–µ–∫—É–Ω–¥</div>
                </div>
            </div>

            <div class="done" id="done">
                üéâ –õ–∞–ø–æ—á–∫–∞ –≤—ã–µ—Ö–∞–ª–∞!
            </div>
        </section>
    </main>

    <!-- Finale elements: photo + train -->
    <div id="photo" class="photo" aria-hidden="true">
        <div class="photo-frame">
            <div class="photo-shot">
                <div class="photo-img" id="photoImg" aria-hidden="true"></div>
                <div class="photo-title" id="photoTitle">–¢–∞–π–º–µ—Ä –¥–æ –ø—Ä–∏–µ–∑–¥–∞ –º–æ–µ–π –ª—é–±–∏–º–æ–π –¥–µ–≤–æ—á–∫–∏</div>
                <div class="photo-time">
                    <span id="photoD">0</span>–¥
                    <span id="photoH">00</span>:<span id="photoM">00</span>:<span id="photoS">00</span>
                </div>
                <div class="photo-caption">üé´ ¬´–í–æ—Ç –º—ã –∏ –¥–æ–∂–¥–∞–ª–∏—Å—å¬ª</div>
            </div>
        </div>
    </div>


    <!-- Ride parallax scene (camera follows the train) -->
    <div class="ride-scene" id="rideScene" aria-hidden="true">
        <div class="ride-layer far" aria-hidden="true"></div>
        <div class="ride-layer mid" aria-hidden="true"></div>
        <div class="ride-layer near" aria-hidden="true"></div>
        <div class="ride-flybys" id="rideFlybys" aria-hidden="true"></div>
        <div class="ride-vignette" aria-hidden="true"></div>
    </div>

    <div class="train-scene" aria-hidden="true">
        <div class="track"></div>

        <div class="train" id="train" aria-hidden="true">
            <div class="engine">
                <div class="chimney"></div>
                <div class="smoke" aria-hidden="true">
                    <span class="puff"></span><span class="puff"></span><span class="puff"></span>
                </div>
                <div class="headlight"></div>
                <div class="nose"></div>
                <div class="wheels">
                    <span class="wheel"></span><span class="wheel"></span><span class="wheel"></span>
                </div>
            </div>

            <div class="wagon">
                <div class="stripe" aria-hidden="true"></div>
                <div class="window w1 seat" id="trainSeat" aria-hidden="true"></div>
                <div class="window w2" aria-hidden="true"></div>
                <div class="window w3" aria-hidden="true"></div>
                <div class="door" aria-hidden="true"></div>
                <div class="wheels">
                    <span class="wheel"></span><span class="wheel"></span><span class="wheel"></span>
                </div>
            </div>

            <div class="wagon">
                <div class="stripe" aria-hidden="true"></div>
                <div class="window w1" aria-hidden="true"></div>
                <div class="window w2" aria-hidden="true"></div>
                <div class="window w3" aria-hidden="true"></div>
                <div class="door" aria-hidden="true"></div>
                <div class="wheels">
                    <span class="wheel"></span><span class="wheel"></span><span class="wheel"></span>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom snow + tree -->
    <div class="bottom" aria-hidden="true">
        <div class="snowbanks">
            <div class="bank bank3"></div>
            <div class="bank bank2"></div>
            <div class="bank bank1"></div>
        </div>

        <div class="tree-wrap">
            <div class="tree">
                <div class="star"></div>

                <!-- –Ø–†–£–°–´: —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö (–ø–ª—é—Å z-index ‚Äî –≤–µ—Ä—Ö–Ω–∏–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –Ω–∏–∂–Ω–∏–µ) -->
                <div class="layer l4"></div>
                <div class="layer l3"></div>
                <div class="layer l2"></div>
                <div class="layer l1"></div>
                <div class="layer l0"></div>

                <!-- –ì–ò–†–õ–Ø–ù–î–ê: –æ–±—ä—ë–º–Ω—ã–µ –ª–∞–º–ø–æ—á–∫–∏ (rope lights) -->
                <svg class="tree-garland g1" viewBox="0 0 200 70" aria-hidden="true">
                    <path class="cable cable-glow" d="M34,24 C78,52 122,8 166,26" />
                    <path class="cable" d="M34,24 C78,52 122,8 166,26" />

                    <g class="tg-bulb" style="--fill: rgba(255,110,110,.96); --glow: rgba(255,110,110,.55); --delay:-.2s;">
                        <circle class="tg-core" cx="44" cy="30" r="6" />
                        <circle class="tg-hi" cx="42" cy="28" r="2.2" />
                        <rect class="tg-cap" x="39" y="18" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,220,120,.96); --glow: rgba(255,220,120,.55); --delay:-.6s;">
                        <circle class="tg-core" cx="64" cy="39" r="5.6" />
                        <circle class="tg-hi" cx="62" cy="37" r="2.0" />
                        <rect class="tg-cap" x="59" y="27" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,255,190,.96); --glow: rgba(120,255,190,.50); --delay:-1.0s;">
                        <circle class="tg-core" cx="88" cy="26" r="5.9" />
                        <circle class="tg-hi" cx="86" cy="24" r="2.1" />
                        <rect class="tg-cap" x="83" y="14" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,180,255,.96); --glow: rgba(120,180,255,.55); --delay:-.4s;">
                        <circle class="tg-core" cx="112" cy="20" r="5.7" />
                        <circle class="tg-hi" cx="110" cy="18" r="2.0" />
                        <rect class="tg-cap" x="107" y="8" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,143,182,.96); --glow: rgba(255,143,182,.55); --delay:-1.2s;">
                        <circle class="tg-core" cx="136" cy="28" r="5.9" />
                        <circle class="tg-hi" cx="134" cy="26" r="2.1" />
                        <rect class="tg-cap" x="131" y="16" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,220,120,.96); --glow: rgba(255,220,120,.55); --delay:-.9s;">
                        <circle class="tg-core" cx="156" cy="36" r="5.5" />
                        <circle class="tg-hi" cx="154" cy="34" r="1.9" />
                        <rect class="tg-cap" x="151" y="24" width="10" height="5" rx="2" />
                    </g>
                </svg>
                <svg class="tree-garland g2" viewBox="0 0 200 70" aria-hidden="true">
                    <path class="cable cable-glow" d="M26,22 C78,58 122,20 174,40" />
                    <path class="cable" d="M26,22 C78,58 122,20 174,40" />

                    <g class="tg-bulb" style="--fill: rgba(120,180,255,.96); --glow: rgba(120,180,255,.55); --delay:-.3s;">
                        <circle class="tg-core" cx="40" cy="34" r="6" />
                        <circle class="tg-hi" cx="38" cy="32" r="2.2" />
                        <rect class="tg-cap" x="35" y="22" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,220,120,.96); --glow: rgba(255,220,120,.55); --delay:-.8s;">
                        <circle class="tg-core" cx="62" cy="48" r="5.8" />
                        <circle class="tg-hi" cx="60" cy="46" r="2.0" />
                        <rect class="tg-cap" x="57" y="36" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,110,110,.96); --glow: rgba(255,110,110,.55); --delay:-.1s;">
                        <circle class="tg-core" cx="90" cy="40" r="5.7" />
                        <circle class="tg-hi" cx="88" cy="38" r="2.0" />
                        <rect class="tg-cap" x="85" y="28" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,255,190,.96); --glow: rgba(120,255,190,.50); --delay:-1.1s;">
                        <circle class="tg-core" cx="116" cy="52" r="5.9" />
                        <circle class="tg-hi" cx="114" cy="50" r="2.1" />
                        <rect class="tg-cap" x="111" y="40" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,143,182,.96); --glow: rgba(255,143,182,.55); --delay:-.5s;">
                        <circle class="tg-core" cx="144" cy="38" r="5.8" />
                        <circle class="tg-hi" cx="142" cy="36" r="2.0" />
                        <rect class="tg-cap" x="139" y="26" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,180,255,.96); --glow: rgba(120,180,255,.55); --delay:-1.3s;">
                        <circle class="tg-core" cx="160" cy="34" r="5.5" />
                        <circle class="tg-hi" cx="158" cy="32" r="1.9" />
                        <rect class="tg-cap" x="155" y="22" width="10" height="5" rx="2" />
                    </g>
                </svg>
                <svg class="tree-garland g3" viewBox="0 0 200 70" aria-hidden="true">
                    <path class="cable cable-glow" d="M22,22 C78,60 122,30 178,46" />
                    <path class="cable" d="M22,22 C78,60 122,30 178,46" />

                    <g class="tg-bulb" style="--fill: rgba(255,143,182,.96); --glow: rgba(255,143,182,.55); --delay:-.2s;">
                        <circle class="tg-core" cx="36" cy="42" r="6" />
                        <circle class="tg-hi" cx="34" cy="40" r="2.2" />
                        <rect class="tg-cap" x="31" y="30" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,220,120,.96); --glow: rgba(255,220,120,.55); --delay:-.7s;">
                        <circle class="tg-core" cx="62" cy="56" r="5.8" />
                        <circle class="tg-hi" cx="60" cy="54" r="2.0" />
                        <rect class="tg-cap" x="57" y="44" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,255,190,.96); --glow: rgba(120,255,190,.50); --delay:-1.0s;">
                        <circle class="tg-core" cx="92" cy="48" r="5.9" />
                        <circle class="tg-hi" cx="90" cy="46" r="2.1" />
                        <rect class="tg-cap" x="87" y="36" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(120,180,255,.96); --glow: rgba(120,180,255,.55); --delay:-.4s;">
                        <circle class="tg-core" cx="122" cy="58" r="5.7" />
                        <circle class="tg-hi" cx="120" cy="56" r="2.0" />
                        <rect class="tg-cap" x="117" y="46" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,110,110,.96); --glow: rgba(255,110,110,.55); --delay:-1.2s;">
                        <circle class="tg-core" cx="150" cy="48" r="5.8" />
                        <circle class="tg-hi" cx="148" cy="46" r="2.0" />
                        <rect class="tg-cap" x="145" y="36" width="10" height="5" rx="2" />
                    </g>
                    <g class="tg-bulb" style="--fill: rgba(255,220,120,.96); --glow: rgba(255,220,120,.55); --delay:-.9s;">
                        <circle class="tg-core" cx="168" cy="46" r="5.5" />
                        <circle class="tg-hi" cx="166" cy="44" r="1.9" />
                        <rect class="tg-cap" x="163" y="34" width="10" height="5" rx="2" />
                    </g>
                </svg>
                <!-- –ò–≥—Ä—É—à–∫–∏ (–ø–µ—Ä–µ—Ä–∞–∑–ª–æ–∂–µ–Ω—ã: —Ä–æ–≤–Ω–µ–µ –ø–æ —è—Ä—É—Å–∞–º –∏ –Ω–µ –≤—ã–ª–µ–∑–∞—é—Ç –∑–∞ –∫–æ–Ω—Ç—É—Ä) -->
                <span class="orn" style="left:94px;  top:54px;  --c: 255,220,120; --s:14px; --delay:-.8s;"></span>
                <span class="orn" style="left:122px; top:70px;  --c: 255,143,182; --s:14px; --delay:-.2s;"></span>
                <span class="orn" style="left:70px;  top:78px;  --c: 120,180,255; --s:15px; --delay:-1.1s;"></span>

                <span class="orn" style="left:96px;  top:96px;  --c: 120,255,190; --s:14px; --delay:-.1s;"></span>
                <span class="orn" style="left:56px;  top:110px; --c: 255,110,110; --s:16px; --delay:-.6s;"></span>
                <span class="orn" style="left:144px; top:108px; --c: 255,220,120; --s:16px; --delay:-1.4s;"></span>

                <span class="orn" style="left:74px;  top:138px; --c: 255,143,182; --s:20px; --delay:-.4s;"></span>
                <span class="orn" style="left:148px; top:140px; --c: 120,180,255; --s:19px; --delay:-1.2s;"></span>

                <span class="orn" style="left:62px;  top:168px; --c: 255,220,120; --s:18px; --delay:-.9s;"></span>
                <span class="orn" style="left:150px; top:170px; --c: 255,110,110; --s:18px; --delay:-.3s;"></span>


                <div class="trunk"></div>
            </div>
        </div>
    </div>

    <!-- Train event music -->
    <audio id="trainMusic" src="assets/track.mp3" preload="auto" loop></audio>

    <script>
        window.FINALE_PHOTO_SRC = "assets/myphoto.jpg";
    </script>


    <script>
        // ----- Countdown -----
        const elD = document.getElementById('d');
        const elH = document.getElementById('h');
        const elM = document.getElementById('m');
        const elS = document.getElementById('s');
        const doneBox = document.getElementById('done');

        

        // ----- Train event music (assets/track.mp3) -----
        const trainMusic = document.getElementById('trainMusic');
        let trainMusicWanted = false;

        function soundEnabled() {
            return (localStorage.getItem('sfxEnabled') ?? '1') === '1';
        }

        function fadeAudio(el, to, ms = 500) {
            if (!el) return;
            const from = Math.max(0, Math.min(1, Number(el.volume) || 0));
            const t0 = performance.now();
            const dur = Math.max(1, ms);
            const step = (t) => {
                const k = Math.min(1, (t - t0) / dur);
                el.volume = from + (to - from) * k;
                if (k < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }

        function unlockTrainMusicOnFirstGesture() {
            if (!trainMusic) return;
            const unlock = () => {
                // attempt to unlock playback for mobile browsers (silent / muted)
                try {
                    trainMusic.muted = true;
                    trainMusic.volume = 0;
                    const p = trainMusic.play();
                    if (p && typeof p.then === 'function') {
                        p.then(() => {
                            setTimeout(() => {
                                try { trainMusic.pause(); } catch (_) { }
                                try { trainMusic.currentTime = 0; } catch (_) { }
                                trainMusic.muted = !soundEnabled();
                            }, 60);
                        }).catch(() => {
                            trainMusic.muted = !soundEnabled();
                        });
                    }
                } catch (_) { }
            };
            window.addEventListener('pointerdown', unlock, { once: true, passive: true });
            window.addEventListener('keydown', unlock, { once: true });
        }
        unlockTrainMusicOnFirstGesture();

        async function startTrainMusic() {
            if (!trainMusic) return;
            trainMusicWanted = true;

            trainMusic.loop = true;
            trainMusic.muted = !soundEnabled();
            trainMusic.volume = 0;
            try { trainMusic.currentTime = 0; } catch (_) { }

            if (!soundEnabled()) return;

            try {
                const p = trainMusic.play();
                if (p && typeof p.catch === 'function') {
                    await p.catch(() => { /* autoplay may be blocked */ });
                }
            } catch (_) { }

            // If autoplay was blocked, retry on the next user gesture
            if (trainMusic.paused) {
                const retry = () => {
                    if (!trainMusicWanted) return;
                    if (!soundEnabled()) return;
                    trainMusic.muted = false;
                    try {
                        const pp = trainMusic.play();
                        if (pp && typeof pp.catch === 'function') pp.catch(() => { });
                    } catch (_) { }
                    fadeAudio(trainMusic, 0.9, 450);
                };
                window.addEventListener('pointerdown', retry, { once: true, passive: true });
                window.addEventListener('keydown', retry, { once: true });
                return;
            }

            fadeAudio(trainMusic, 0.9, 700);
        }

        function stopTrainMusic() {
            // NOTE: user requested the track to NOT end.
            // So we intentionally keep the music playing (it loops).
            trainMusicWanted = true;
            if (!trainMusic) return;
            trainMusic.loop = true;
            // keep current volume; do not pause/reset
        }

        // keep trainMusic in sync with the üîä/üîá button
        const _soundBtnForMusic = document.getElementById('soundToggle');
        if (_soundBtnForMusic) {
            _soundBtnForMusic.addEventListener('click', () => {
                // let other handler update localStorage first
                setTimeout(() => {
                    if (!trainMusic) return;
                    const en = soundEnabled();
                    trainMusic.muted = !en;

                    // if the train event is active and user enabled sound ‚Äî try to start/resume
                    if (en && trainMusicWanted && trainMusic.paused) {
                        try {
                            const p = trainMusic.play();
                            if (p && typeof p.catch === 'function') p.catch(() => { });
                        } catch (_) { }
                        fadeAudio(trainMusic, 0.9, 450);
                    }
                }, 0);
            });
        }

// Target: 27 Dec 2025 00:00 local time
        const target = new Date(2025, 11, 27, 0, 0, 0); // month is 0-based: 11 = December

        function pad2(n) { return String(n).padStart(2, '0'); }

        let lastDays = null;

        function emitDayChange(days) {
            document.dispatchEvent(new CustomEvent('daychange', { detail: { days } }));
        }

        function tick() {
            const now = new Date();
            let diff = target - now;

            if (diff <= 0) {
                elD.textContent = "0";
                elH.textContent = "00";
                elM.textContent = "00";
                elS.textContent = "00";
                doneBox.style.display = "block";
                onTimerDone();
                return;
            }

            const totalSeconds = Math.floor(diff / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;


            if (lastDays === null) lastDays = days;
            if (days !== lastDays) {
                lastDays = days;
                emitDayChange(days);
            }
            elD.textContent = days;
            elH.textContent = pad2(hours);
            elM.textContent = pad2(mins);
            elS.textContent = pad2(secs);
        }
        const timerInterval = setInterval(tick, 1000);
        tick();


        // ----- Finale: —Ç–∞–π–º–µ—Ä —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ ¬´—Ñ–æ—Ç–æ¬ª –∏ —É–µ–∑–∂–∞–µ—Ç –≤ –≤–∞–≥–æ–Ω—á–∏–∫–µ -----
        const photo = document.getElementById('photo');
        const photoTitle = document.getElementById('photoTitle');
        const photoD = document.getElementById('photoD');
        const photoH = document.getElementById('photoH');
        const photoM = document.getElementById('photoM');
        const photoS = document.getElementById('photoS');
        const photoImg = document.getElementById('photoImg');

        // –£–∫–∞–∂–∏ –∑–¥–µ—Å—å –ø—É—Ç—å –∫ —Å–≤–æ–µ–º—É —Ñ–æ—Ç–æ (1:1). –ù–∞–ø—Ä–∏–º–µ—Ä: 'myphoto.jpg' –∏–ª–∏ 'assets/myphoto.jpg'
        // Finale photo: by default looks for a file named "myphoto.jpg" next to this HTML.
        // You can override by setting: window.FINALE_PHOTO_SRC = "assets/myphoto.jpg";
        const PHOTO_CANDIDATES = (() => {
            const override = (window.FINALE_PHOTO_SRC || "").trim();
            if (override) return [override];
            return [
                "myphoto.jpg",
                "myphoto.JPG",
                "myphoto.jpeg",
                "myphoto.JPEG",
                "myphoto.png",
                "myphoto.PNG",
                "assets/myphoto.jpg",
                "assets/myphoto.JPG",
                "assets/myphoto.png",
                "assets/myphoto.PNG",
            ];
        })();

        function tryLoadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img.src);
                img.onerror = () => reject(new Error("Image not found: " + src));
                // cache-bust to avoid stubborn caching while you iterate
                const bust = (src.includes("?") ? "&" : "?") + "v=" + Date.now();
                img.src = src + bust;
            });
        }

        async function resolveFinalePhotoSrc() {
            for (const src of PHOTO_CANDIDATES) {
                try {
                    const ok = await tryLoadImage(src);
                    // strip cachebust before using as CSS background (not required, but neat)
                    return ok;
                } catch (e) { }
            }
            return null;
        }

        function showPhotoPicker() {
            const btn = document.getElementById("pickPhotoBtn");
            const input = document.getElementById("pickPhotoInput");
            if (!btn || !input) return;

            btn.hidden = false;

            btn.addEventListener("click", () => input.click(), { once: false });
            input.addEventListener("change", () => {
                const file = input.files && input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    window.__FINALE_PHOTO_DATAURL__ = dataUrl;
                    btn.hidden = true;
                };
                reader.readAsDataURL(file);
            }, { once: false });
        }
        let _photoLoaded = false;
        try {
            const _pre = new Image();
            _pre.onload = () => { _photoLoaded = true; };
            _pre.onerror = () => { _photoLoaded = false; };
            _pre.src = PHOTO_SRC;
        } catch (e) { /* noop */ }


        const train = document.getElementById('train');
        const trainSeat = document.getElementById('trainSeat');
        const card = document.querySelector('.card');

        const rideScene = document.getElementById('rideScene');
        const rideFlybys = document.getElementById('rideFlybys');

        const prefersReduceMotion = () => (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);

        let rideRunning = false;
        let rideRAF = 0;
        let rideLastT = 0;
        let rideLayers = null;
        let flybyTimer = 0;

        function ensureRideLayers(){
            if (rideLayers) return rideLayers;
            if (!rideScene) return (rideLayers = []);
            rideLayers = Array.from(rideScene.querySelectorAll('.ride-layer')).map((el) => {
                const cs = getComputedStyle(el);
                const tile = parseFloat(cs.getPropertyValue('--tile')) || 500;
                const speed = parseFloat(cs.getPropertyValue('--speed')) || 12;
                return { el, tile, speed, x: 0 };
            });
            return rideLayers;
        }

        function rideStep(t){
            if (!rideRunning) return;

            if (!rideLastT) rideLastT = t;
            const dt = Math.min(34, Math.max(0, t - rideLastT));
            rideLastT = t;

            const layers = ensureRideLayers();
            for (const L of layers) {
                // speed is tuned for ~60fps
                L.x += (L.speed * (dt / 16.6667));
                const m = ((L.x % L.tile) + L.tile) % L.tile;
                L.el.style.backgroundPosition = `-${m.toFixed(2)}px 100%`;
            }

            rideRAF = requestAnimationFrame(rideStep);
        }

        function spawnFlyby(){
            if (!rideRunning || !rideFlybys) return;
            if (prefersReduceMotion()) return;

            const el = document.createElement('div');
            const isTree = Math.random() < 0.64;
            el.className = 'flyby ' + (isTree ? 'tree' : 'lamp');

            if (isTree) {
                el.innerHTML = '<span class="trunk"></span><span class="canopy c1"></span><span class="canopy c2"></span><span class="canopy c3"></span>';
            } else {
                el.innerHTML = '<span class="post"></span><span class="arm"></span><span class="head"></span><span class="glow"></span>';
            }

            // 0..1 (nearer objects are bigger + faster)
            const depth = Math.pow(Math.random(), 0.65);

            const scale = 0.48 + depth * 0.88;
            const blur = (1 - depth) * 1.35;
            const dur = 4200 - depth * 2250; // ms

            const bottom = Math.round((1 - depth) * 10) + (isTree ? 0 : 4);

            el.style.setProperty('--scale', scale.toFixed(3));
            el.style.setProperty('--blur', blur.toFixed(2) + 'px');
            el.style.setProperty('--dur', Math.round(dur) + 'ms');
            el.style.setProperty('--fromX', '112vw');
            el.style.setProperty('--toX', '-18vw');
            el.style.bottom = bottom + 'px';

            rideFlybys.appendChild(el);

            setTimeout(() => { try { el.remove(); } catch (e) { } }, dur + 80);

            const next = 520 + Math.random() * 980;
            clearTimeout(flybyTimer);
            flybyTimer = window.setTimeout(spawnFlyby, next);
        }

        function startRide(){
            if (rideRunning) return;
            if (prefersReduceMotion()) return;

            rideRunning = true;
            rideLastT = 0;

            document.body.classList.add('ride');

            try{
                const layers = ensureRideLayers();
                layers.forEach((L) => { L.x = 0; L.el.style.backgroundPosition = '0 100%'; });
            }catch(_){}

            cancelAnimationFrame(rideRAF);
            rideRAF = requestAnimationFrame(rideStep);

            clearTimeout(flybyTimer);
            flybyTimer = window.setTimeout(spawnFlyby, 260);
        }

        function stopRide(){
            rideRunning = false;
            document.body.classList.remove('ride');
            try { cancelAnimationFrame(rideRAF); } catch (_) { }
            clearTimeout(flybyTimer);
            if (rideFlybys) rideFlybys.innerHTML = '';
        }



        let timerDone = false;

        function _anim(el, keyframes, options) {
            if (!el) return Promise.resolve();
            if (typeof el.animate !== 'function') {
                const last = keyframes[keyframes.length - 1] || {};
                if (last.transform) el.style.transform = last.transform;
                if (last.opacity != null) el.style.opacity = String(last.opacity);
                return Promise.resolve();
            }
            const a = el.animate(keyframes, options);
            return a.finished || new Promise((res) => a.addEventListener('finish', res, { once: true }));
        }



        async function onTimerDone() {
            if (timerDone) return;
            timerDone = true;


            // Hide the static tree that was shown under the timer (we switch to the ride scene)
            const treeWrap = document.querySelector('.tree-wrap');
            if (treeWrap) {
                treeWrap.classList.add('is-hidden');
                setTimeout(() => { treeWrap.style.display = 'none'; }, 650);
            }

            try { clearInterval(timerInterval); } catch (e) { /* noop */ }
            doneBox.style.display = "block";

            const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reduce || !photo || !card || !train) {
                if (card) card.style.opacity = '0';
                return;
            }

            // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ ¬´—Ñ–æ—Ç–æ¬ª –±–µ—Ä—ë–º –∏–∑ —Ç–∞–π–º–µ—Ä–∞
            if (photoTitle) photoTitle.textContent = (document.querySelector('h1')?.textContent || '–¢–∞–π–º–µ—Ä');
            if (photoD) photoD.textContent = elD.textContent;
            if (photoH) photoH.textContent = elH.textContent;
            if (photoM) photoM.textContent = elM.textContent;
            if (photoS) photoS.textContent = elS.textContent;

            // 1) ¬´–§–æ—Ç–æ¬ª –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–∞–π–º–µ—Ä–∞ (–∫–∞–∫ –±—É–¥—Ç–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º)
            const r = card.getBoundingClientRect();
            photo.style.display = 'block';
            photo.style.left = `${r.left}px`;
            photo.style.top = `${r.top}px`;
            photo.style.width = `${r.width}px`;
            photo.style.height = `${r.height}px`;
            photo.style.opacity = '1';
            photo.style.transform = 'translate(0px,0px) scale(1) rotate(0deg)';

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º "–∫–∞—Ä—Ç–∏–Ω–∫–∞" (—Ñ–æ—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–∏—Å–µ—Ç—å –∑–∞—Ä–∞–Ω–µ–µ)
            try { photo.classList.remove('is-image'); } catch (e) { }
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ñ–æ–Ω-–∫–∞—Ä—Ç–∏–Ω–∫—É, –Ω–æ –ø–æ–∫–∞–∂–µ–º –µ—ë —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è

            // Load the finale photo ONLY at the end (not as a permanent background)
            let finaleSrc = window.__FINALE_PHOTO_DATAURL__ || await resolveFinalePhotoSrc();
            if (!finaleSrc) {
                // If the file wasn't found (common when you forgot to upload it to hosting),
                // show a picker so you can choose a local image.
                showPhotoPicker();
                // proceed without photo; the square will stay as a styled frame
            } else if (photoImg) {
                photoImg.style.backgroundImage = `url('${finaleSrc}')`;
            }

            document.body.classList.add('finale');

            // –ü–ª–∞–≤–Ω–æ –ø—Ä—è—á–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            _anim(card, [{ opacity: 1 }, { opacity: 0 }], { duration: 420, easing: 'ease', fill: 'forwards' });

            // 1.5) –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –≤ –∫–≤–∞–¥—Ä–∞—Ç 1:1 –∏ –ø—Ä–æ—è–≤–ª—è–µ–º —Ç–≤–æ—ë —Ñ–æ—Ç–æ
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            const size = Math.min(r.width, r.height);
            const tLeft = cx - size / 2;
            const tTop = cy - size / 2;

            // –ø—Ä–æ—è–≤–ª—è–µ–º —Ñ–æ—Ç–æ —á—É—Ç—å –ø–æ–∑–∂–µ, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ "—Å–∂–∞—Ç–∏–µ" –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É
            const hasPhoto = !!finaleSrc && !!photoImg;

            if (hasPhoto) {
                setTimeout(() => photo.classList.add('is-image'), 160);
            } else {
                // –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –ù–ï –ø—Ä—è—á–µ–º —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∞–ª—Å—è –ø—É—Å—Ç–æ–π –∫–≤–∞–¥—Ä–∞—Ç
                photo.classList.remove('is-image');
            }

            await _anim(photo,
                [
                    { left: `${r.left}px`, top: `${r.top}px`, width: `${r.width}px`, height: `${r.height}px` },
                    { left: `${tLeft}px`, top: `${tTop}px`, width: `${size}px`, height: `${size}px` }
                ],
                { duration: 520, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' }
            );


            // 2) –ü–æ–µ–∑–¥ –ø–æ–¥—ä–µ–∑–∂–∞–µ—Ç –∏ "–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è"
            // üéµ music for the train event
            try { await startTrainMusic(); } catch (_) { }


            train.classList.add('moving');
            train.style.opacity = '1';

            await _anim(train,
                [{ transform: 'translateX(-180%)', opacity: 0 }, { transform: 'translateX(-50%)', opacity: 1 }],
                { duration: 1500, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' }
            );

            train.classList.remove('moving');

            // 3) ¬´–§–æ—Ç–æ¬ª —Å–∞–¥–∏—Ç—Å—è –≤ –æ–∫–æ—à–∫–æ
            if (trainSeat) {
                const rf = photo.getBoundingClientRect();
                const rt = trainSeat.getBoundingClientRect();
                const dx = (rt.left + rt.width / 2) - (rf.left + rf.width / 2);
                const dy = (rt.top + rt.height / 2) - (rf.top + rf.height / 2);
                const scale = Math.min(rt.width / rf.width, rt.height / rf.height) * 0.92;

                await _anim(photo, [
                    { transform: 'translate(0px,0px) scale(1) rotate(0deg)' },
                    { transform: `translate(${dx}px,${dy}px) scale(${scale}) rotate(-7deg)` }
                ], { duration: 1200, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' });

                // FLIP: "–ø—Ä–∏–∫–ª–µ–∏–≤–∞–µ–º" —Ñ–æ—Ç–æ –≤ –æ–∫–Ω–æ –±–µ–∑ —Ä—ã–≤–∫–∞
                const before = photo.getBoundingClientRect();

                trainSeat.appendChild(photo);
                photo.classList.add('in-seat');
                photo.style.position = 'absolute';
                photo.style.left = '0';
                photo.style.top = '0';
                photo.style.width = '100%';
                photo.style.height = '100%';
                photo.style.opacity = '1';

                const after = photo.getBoundingClientRect();
                const dx2 = before.left - after.left;
                const dy2 = before.top - after.top;
                const sx2 = before.width / after.width;
                const sy2 = before.height / after.height;

                photo.style.transform = `translate(${dx2}px,${dy2}px) scale(${sx2},${sy2}) rotate(-7deg)`;
                await new Promise(requestAnimationFrame);

                await _anim(photo, [
                    { transform: `translate(${dx2}px,${dy2}px) scale(${sx2},${sy2}) rotate(-7deg)` },
                    { transform: 'translate(0px,0px) scale(1) rotate(0deg)' }
                ], { duration: 260, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' });
            } else {
                // –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –æ–∫–Ω–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ "—Å–≤–µ—Ä–Ω—ë–º" –∏ —Å–ø—Ä—è—á–µ–º
                await _anim(photo,
                    [{ transform: 'translate(0px,0px) scale(1) rotate(0deg)', opacity: 1 },
                    { transform: `translate(0px,${Math.max(220, window.innerHeight * 0.35)}px) scale(.25) rotate(-6deg)`, opacity: 0 }],
                    { duration: 1200, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' }
                );
            }

            // 4) –ü–æ–µ–∑–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫–∞–¥—Ä–µ, –∞ ¬´–∫–∞–º–µ—Ä–∞¬ª –µ–¥–µ—Ç –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º:
            //    –¥–≤–∏–≥–∞–µ–º —Å–ª–æ–∏ –ø–µ–π–∑–∞–∂–∞ (–ø–∞—Ä–∞–ª–ª–∞–∫—Å) + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ª–µ—Ç–∞—é—Ç —ë–ª–æ—á–∫–∏/—Ñ–æ–Ω–∞—Ä–∏
            train.classList.add('moving');
            startRide();

        }


        // ----- Garland bulbs (better alignment along the wire path) -----
        (function buildGarland() {
            const g = document.getElementById('bulbs');
            const path = document.getElementById('wirePath');
            if (!g || !path || typeof path.getTotalLength !== 'function') return;

            const svgns = "http://www.w3.org/2000/svg";
            const colors = [
                { fill: "rgba(255,110,110,.96)", glow: "rgba(255,110,110,.55)" },
                { fill: "rgba(255,220,120,.96)", glow: "rgba(255,220,120,.55)" },
                { fill: "rgba(120,255,190,.96)", glow: "rgba(120,255,190,.50)" },
                { fill: "rgba(120,180,255,.96)", glow: "rgba(120,180,255,.55)" },
                { fill: "rgba(255,143,182,.96)", glow: "rgba(255,143,182,.55)" }
            ];

            const total = path.getTotalLength();
            const count = 30;

            function rand(min, max) { return min + Math.random() * (max - min); }

            for (let i = 0; i < count; i++) {
                const L = (count === 1) ? 0 : total * (i / (count - 1));
                const p = path.getPointAtLength(L);

                const dx = rand(-10, 10);
                const hang = rand(14, 26);
                const rot = rand(-8, 8);
                const size = rand(8.5, 11.5);

                const c = colors[i % colors.length];

                const holder = document.createElementNS(svgns, "g");
                holder.setAttribute("class", "g-bulb");
                holder.setAttribute("transform", `translate(${p.x.toFixed(2)},${p.y.toFixed(2)})`);

                const pulse = document.createElementNS(svgns, "g");
                pulse.setAttribute("class", "g-bulbPulse");
                pulse.style.setProperty("--fill", c.fill);
                pulse.style.setProperty("--glow", c.glow);
                pulse.style.setProperty("--delay", (-i * 0.18) + "s");
                pulse.style.setProperty("--dur", rand(2.4, 3.8).toFixed(2) + "s");

                const d = `M0,0 Q${(dx * 0.35).toFixed(2)},${(hang * 0.55).toFixed(2)} ${dx.toFixed(2)},${hang.toFixed(2)}`;

                const dropGlow = document.createElementNS(svgns, "path");
                dropGlow.setAttribute("class", "g-drop g-drop-glow");
                dropGlow.setAttribute("d", d);
                pulse.appendChild(dropGlow);

                const drop = document.createElementNS(svgns, "path");
                drop.setAttribute("class", "g-drop");
                drop.setAttribute("d", d);
                pulse.appendChild(drop);

                const bulb = document.createElementNS(svgns, "g");
                bulb.setAttribute("transform", `translate(${dx.toFixed(2)},${hang.toFixed(2)}) rotate(${rot.toFixed(2)})`);

                const cap = document.createElementNS(svgns, "rect");
                cap.setAttribute("class", "g-cap");
                cap.setAttribute("x", (-size * 0.85).toFixed(2));
                cap.setAttribute("y", (-size * 1.95).toFixed(2));
                cap.setAttribute("width", (size * 1.70).toFixed(2));
                cap.setAttribute("height", (size * 0.68).toFixed(2));
                cap.setAttribute("rx", (size * 0.22).toFixed(2));
                bulb.appendChild(cap);

                const neck = document.createElementNS(svgns, "rect");
                neck.setAttribute("class", "g-neck");
                neck.setAttribute("x", (-size * 0.36).toFixed(2));
                neck.setAttribute("y", (-size * 1.27).toFixed(2));
                neck.setAttribute("width", (size * 0.72).toFixed(2));
                neck.setAttribute("height", (size * 0.40).toFixed(2));
                neck.setAttribute("rx", (size * 0.18).toFixed(2));
                bulb.appendChild(neck);

                const glass = document.createElementNS(svgns, "ellipse");
                glass.setAttribute("class", "g-glass");
                glass.setAttribute("cx", "0");
                glass.setAttribute("cy", (size * 0.15).toFixed(2));
                glass.setAttribute("rx", size.toFixed(2));
                glass.setAttribute("ry", (size * 1.25).toFixed(2));
                bulb.appendChild(glass);

                const shadow = document.createElementNS(svgns, "ellipse");
                shadow.setAttribute("class", "g-shadow");
                shadow.setAttribute("cx", (size * 0.28).toFixed(2));
                shadow.setAttribute("cy", (size * 0.60).toFixed(2));
                shadow.setAttribute("rx", (size * 0.72).toFixed(2));
                shadow.setAttribute("ry", (size * 0.95).toFixed(2));
                bulb.appendChild(shadow);

                const hi = document.createElementNS(svgns, "ellipse");
                hi.setAttribute("class", "g-hi");
                hi.setAttribute("cx", (-size * 0.36).toFixed(2));
                hi.setAttribute("cy", (-size * 0.20).toFixed(2));
                hi.setAttribute("rx", (size * 0.28).toFixed(2));
                hi.setAttribute("ry", (size * 0.42).toFixed(2));
                bulb.appendChild(hi);

                pulse.appendChild(bulb);
                holder.appendChild(pulse);
                g.appendChild(holder);
            }
        })();


        // ----- FX (confetti / sparkles) -----
        (function fxLayer() {
            const c = document.getElementById('fx');
            if (!c) return;
            const ctx = c.getContext('2d');

            let W = 0, H = 0, dpr = 1;
            function resize() {
                dpr = Math.max(1, window.devicePixelRatio || 1);
                W = c.width = Math.floor(window.innerWidth * dpr);
                H = c.height = Math.floor(window.innerHeight * dpr);
                c.style.width = window.innerWidth + "px";
                c.style.height = window.innerHeight + "px";
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            window.addEventListener('resize', resize, { passive: true });
            resize();

            const parts = [];

            const rockets = [];
            const sparks = [];

            function fwBurst(x, y, count = 84, colOverride = null) {
                const now = performance.now();
                const c = colOverride || palette[(Math.random() * palette.length) | 0];
                // c is [r,g,b]
                for (let i = 0; i < count; i++) {
                    const ang = rand(0, Math.PI * 2);
                    const sp = rand(1.8, 7.8);
                    sparks.push({
                        x, y,
                        vx: Math.cos(ang) * sp,
                        vy: Math.sin(ang) * sp,
                        g: 0.07 + Math.random() * 0.09,
                        drag: 0.985,
                        size: rand(1.2, 3.2),
                        life: rand(920, 1650),
                        born: now,
                        a: 1,
                        col: c,
                        tw: rand(0.8, 1.6) // twinkle
                    });
                }
            }

            function launchFirework(side = 'left') {
                const now = performance.now();
                const w = window.innerWidth;
                const h = window.innerHeight;

                const fromLeft = side === 'left';
                const x0 = fromLeft ? rand(24, 64) : w - rand(24, 64);
                const y0 = h - rand(110, 190); // from snowbanks area
                const vx0 = fromLeft ? rand(2.2, 4.2) : -rand(2.2, 4.2);
                const vy0 = -rand(8.8, 11.2);

                const apexY = rand(140, 300);
                const col = palette[(Math.random() * palette.length) | 0];

                rockets.push({
                    x: x0, y: y0,
                    px: x0, py: y0,
                    vx: vx0, vy: vy0,
                    g: 0.12,
                    drag: 0.995,
                    born: now,
                    life: rand(900, 1500),
                    apexY,
                    col
                });
            }

            function fireworksPair() {
                launchFirework('left');
                launchFirework('right');
            }

            function fireworksShow(durationMs = 6000) {
                // 3 waves across ~6 seconds
                const times = [120, 2280, 4440];
                times.forEach((t) => {
                    setTimeout(() => fireworksPair(), t);
                });
            }
            const palette = [
                [120, 180, 255], [120, 255, 190], [255, 220, 120], [255, 140, 200], [180, 120, 255], [255, 160, 120]
            ];
            const rand = (a, b) => a + Math.random() * (b - a);

            function burst(x, y, count = 110) {
                const now = performance.now();
                for (let i = 0; i < count; i++) {
                    const c = palette[(Math.random() * palette.length) | 0];
                    const ang = rand(-Math.PI, 0); // shoot upward-ish
                    const sp = rand(2.8, 8.8);
                    parts.push({
                        x, y,
                        vx: Math.cos(ang) * sp + rand(-1.0, 1.0),
                        vy: Math.sin(ang) * sp + rand(-1.2, 0.8),
                        g: 0.18 + Math.random() * 0.22,
                        drag: 0.985,
                        size: rand(3, 8),
                        rot: rand(0, Math.PI * 2),
                        vr: rand(-0.22, 0.22),
                        life: rand(900, 1550),
                        born: now,
                        a: 1,
                        col: `rgba(${c[0]},${c[1]},${c[2]},`
                    });
                }
            }

            function starburst(x, y, count = 28) {
                const now = performance.now();
                for (let i = 0; i < count; i++) {
                    const c = palette[(Math.random() * palette.length) | 0];
                    const ang = rand(0, Math.PI * 2);
                    const sp = rand(1.2, 5.0);
                    parts.push({
                        x, y,
                        vx: Math.cos(ang) * sp,
                        vy: Math.sin(ang) * sp,
                        g: 0.05,
                        drag: 0.97,
                        size: rand(1.5, 3.6),
                        rot: rand(0, Math.PI * 2),
                        vr: rand(-0.45, 0.45),
                        life: rand(520, 900),
                        born: now,
                        a: 1,
                        col: `rgba(${c[0]},${c[1]},${c[2]},`
                    });
                }
            }

            function step(t) {
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

                // ---- Fireworks rockets ----
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';

                for (let i = rockets.length - 1; i >= 0; i--) {
                    const r = rockets[i];
                    const age = t - r.born;
                    if (age > r.life) { rockets.splice(i, 1); continue; }

                    r.px = r.x; r.py = r.y;
                    r.vx *= r.drag;
                    r.vy = (r.vy * r.drag) + r.g;
                    r.x += r.vx;
                    r.y += r.vy;

                    // trail
                    const a = Math.max(0, Math.min(1, 1 - (age / r.life)));
                    ctx.lineWidth = 2.0;
                    ctx.strokeStyle = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},${(0.18 + 0.42 * a).toFixed(3)})`;
                    ctx.beginPath();
                    ctx.moveTo(r.px, r.py);
                    ctx.lineTo(r.x, r.y);
                    ctx.stroke();

                    // small glowing head
                    ctx.shadowBlur = 18;
                    ctx.shadowColor = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},.85)`;
                    ctx.fillStyle = `rgba(${r.col[0]},${r.col[1]},${r.col[2]},${(0.45 + 0.45 * a).toFixed(3)})`;
                    ctx.beginPath();
                    ctx.arc(r.x, r.y, 2.2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // explode near apex
                    if (r.y <= r.apexY || r.vy > -0.6) {
                        fwBurst(r.x, r.y, 88, r.col);
                        fwBurst(r.x + rand(-8, 8), r.y + rand(-6, 6), 52, r.col);
                        rockets.splice(i, 1);
                    }
                }

                // ---- Fireworks sparks ----
                for (let i = sparks.length - 1; i >= 0; i--) {
                    const p = sparks[i];
                    const age = t - p.born;
                    if (age > p.life) { sparks.splice(i, 1); continue; }

                    const k = 1 - (age / p.life);
                    p.a = Math.max(0, Math.min(1, k));
                    p.vx *= p.drag;
                    p.vy = (p.vy * p.drag) + p.g;
                    p.x += p.vx;
                    p.y += p.vy;

                    // twinkle
                    const tw = 0.65 + 0.35 * Math.sin((age * 0.018) + p.tw);

                    ctx.shadowBlur = 16;
                    ctx.shadowColor = `rgba(${p.col[0]},${p.col[1]},${p.col[2]},.85)`;
                    ctx.fillStyle = `rgba(${p.col[0]},${p.col[1]},${p.col[2]},${(0.10 + 0.78 * p.a * tw).toFixed(3)})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();

                    // tiny streak
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 0.22 * p.a;
                    ctx.strokeStyle = `rgba(255,255,255,1)`;
                    ctx.lineWidth = 1.0;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x - p.vx * 0.8, p.y - p.vy * 0.8);
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                ctx.restore();
                ctx.globalCompositeOperation = 'source-over';

                // ---- Confetti parts ----
                for (let i = parts.length - 1; i >= 0; i--) {
                    const p = parts[i];
                    const age = t - p.born;
                    if (age > p.life) { parts.splice(i, 1); continue; }

                    const k = 1 - (age / p.life);
                    p.a = Math.max(0, Math.min(1, k));
                    p.vx *= p.drag;
                    p.vy = (p.vy * p.drag) + p.g;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.rot += p.vr;

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot);

                    const s = p.size;
                    ctx.fillStyle = p.col + (0.10 + 0.90 * p.a).toFixed(3) + ")";
                    ctx.fillRect(-s * 0.5, -s * 0.5, s, s * 0.7);

                    // tiny highlight
                    ctx.globalAlpha = 0.25 * p.a;
                    ctx.fillStyle = "rgba(255,255,255,1)";
                    ctx.fillRect(-s * 0.15, -s * 0.35, s * 0.22, s * 0.22);

                    ctx.restore();
                }

                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);

            window.__fxBurst = burst;
            window.__fxStarburst = starburst;
            window.__fxFireworksShow = fireworksShow;
            window.__fxFireworksPair = fireworksPair;
            window.__fxLaunchFirework = launchFirework;
        })();


        // ----- Snow (canvas) -----
        (function snow() {
            const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (reduce) return;

            const canvas = document.getElementById('snow');
            const ctx = canvas.getContext('2d');

            let w, h, dpr;
            function resize() {
                dpr = Math.max(1, window.devicePixelRatio || 1);
                w = canvas.width = Math.floor(window.innerWidth * dpr);
                h = canvas.height = Math.floor(window.innerHeight * dpr);
                canvas.style.width = window.innerWidth + "px";
                canvas.style.height = window.innerHeight + "px";
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            window.addEventListener('resize', resize, { passive: true });
            resize();

            const flakes = [];
            const maxFlakes = Math.min(220, Math.floor(window.innerWidth * 0.18));

            let gustUntil = 0;
            let gustWind = 0;
            let gustStrength = 0;
            let gustDur = 2200;

            function snowGust(ms = 2200, strength = 1.2) {
                const now = performance.now();
                const newUntil = now + ms;

                // if we are extending the gust, remember its real duration
                if (newUntil > gustUntil) {
                    gustUntil = newUntil;
                    gustDur = ms;
                } else {
                    gustUntil = Math.max(gustUntil, newUntil);
                    gustDur = Math.max(gustDur, ms);
                }

                gustStrength = Math.max(gustStrength, strength);
                gustWind = (Math.random() < 0.5 ? -1 : 1) * (1.2 + Math.random() * 1.8) * gustStrength;
            }

            function snowBurst(extra = 140) {
                const now = performance.now();
                for (let i = 0; i < extra; i++) {
                    flakes.push({
                        x: rand(0, window.innerWidth),
                        y: rand(-120, -10),
                        r: rand(1.0, 3.4),
                        v: rand(1.0, 2.6),
                        drift: rand(-0.8, 0.8),
                        a: rand(0.55, 0.95),
                        temp: true,
                        born: now,
                        life: rand(900, 1600)
                    });
                }
            }

            window.__snowGust = snowGust;
            window.__snowBurst = snowBurst;
            function rand(min, max) { return min + Math.random() * (max - min); }

            for (let i = 0; i < maxFlakes; i++) {
                flakes.push({
                    x: rand(0, window.innerWidth),
                    y: rand(-window.innerHeight, window.innerHeight),
                    r: rand(1.0, 3.2),
                    v: rand(0.5, 1.6),
                    drift: rand(-0.6, 0.6),
                    a: rand(0.55, 0.95)
                });
            }

            function step() {
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

                const nowT = performance.now();
                const gRaw = gustUntil > nowT ? (gustUntil - nowT) / gustDur : 0;
                const g = Math.max(0, Math.min(1, gRaw));
                const speedMult = 1 + 1.9 * g;
                const wind = gustWind * g;

                for (let i = flakes.length - 1; i >= 0; i--) {
                    const f = flakes[i];
                    if (f.temp && (nowT - f.born) > f.life) { flakes.splice(i, 1); continue; }

                    f.y += f.v * speedMult;
                    f.x += (f.drift + wind) + Math.sin((f.y + f.x) * 0.003) * (0.35 + 0.55 * g) + Math.sin(nowT * 0.003 + f.y * 0.01) * 0.25 * g;

                    if (f.y > window.innerHeight + 12) {
                        f.y = rand(-80, -10);
                        f.x = rand(0, window.innerWidth);
                    }
                    if (f.x < -10) f.x = window.innerWidth + 10;
                    if (f.x > window.innerWidth + 10) f.x = -10;

                    ctx.beginPath();
                    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255,255,255,${f.a})`;
                    ctx.fill();
                }

                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        })();

        // ----- Day-change WOW -----
        (function dayChangeEffects() {
            const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            const card = document.querySelector('.card');

                    const toast = document.getElementById('toast');
            const aurora = document.querySelector('.aurora');
            const treeGarland = document.querySelector('.tree-garland');
            const star = document.querySelector('.tree .star, .star');
            const topGarland = document.querySelector('.garland');
            const soundBtn = document.getElementById('soundToggle');

            // ----- Tiny SFX (WebAudio) -----
            let sfxEnabled = (localStorage.getItem('sfxEnabled') ?? '1') === '1';
            let audioCtx = null;
            let master = null;

            function updateSoundBtn() {
                if (!soundBtn) return;
                soundBtn.textContent = sfxEnabled ? 'üîä' : 'üîá';
                soundBtn.setAttribute('aria-pressed', sfxEnabled ? 'true' : 'false');
                soundBtn.title = sfxEnabled ? '–ó–≤—É–∫: –í–∫–ª' : '–ó–≤—É–∫: –í—ã–∫–ª';
            }

            function ensureAudio() {
                if (!sfxEnabled) return null;
                if (!audioCtx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    if (!AC) return null;
                    audioCtx = new AC();
                    master = audioCtx.createGain();
                    master.gain.value = 0.22; // overall volume
                    master.connect(audioCtx.destination);
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().catch(() => { });
                }
                return audioCtx;
            }

            function envGain(g, t0, a = 0.005, d = 0.12, s = 0.0, r = 0.12, peak = 1.0) {
                g.gain.cancelScheduledValues(t0);
                g.gain.setValueAtTime(0.0001, t0);
                g.gain.exponentialRampToValueAtTime(Math.max(0.0001, peak), t0 + a);
                g.gain.exponentialRampToValueAtTime(Math.max(0.0001, s + 0.0001), t0 + a + d);
                g.gain.exponentialRampToValueAtTime(0.0001, t0 + a + d + r);
            }

            function sfxChime() {
                const ctx = ensureAudio();
                if (!ctx || !master) return;

                const t0 = ctx.currentTime + 0.005;
                const notes = [784, 988, 1319]; // G5, B5, E6-ish
                notes.forEach((f, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(f, t0 + i * 0.08);
                    o.connect(g);

                    // gentle shimmer
                    const lp = ctx.createBiquadFilter();
                    lp.type = 'lowpass';
                    lp.frequency.setValueAtTime(6000, t0);
                    g.connect(lp);
                    lp.connect(master);

                    envGain(g, t0 + i * 0.08, 0.01, 0.10, 0.0001, 0.22, 0.75);
                    o.start(t0 + i * 0.08);
                    o.stop(t0 + i * 0.08 + 0.45);
                });
            }

            function sfxPop() {
                const ctx = ensureAudio();
                if (!ctx || !master) return;

                const t0 = ctx.currentTime + 0.005;

                // click
                const o = ctx.createOscillator();
                o.type = 'sine';
                o.frequency.setValueAtTime(220, t0);
                o.frequency.exponentialRampToValueAtTime(880, t0 + 0.03);

                const g = ctx.createGain();
                o.connect(g);
                envGain(g, t0, 0.002, 0.04, 0.0001, 0.06, 0.55);
                g.connect(master);
                o.start(t0);
                o.stop(t0 + 0.12);

                // tiny noise burst
                const dur = 0.08;
                const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 2);
                }
                const n = ctx.createBufferSource();
                n.buffer = buf;

                const hp = ctx.createBiquadFilter();
                hp.type = 'highpass';
                hp.frequency.setValueAtTime(1200, t0);

                const gn = ctx.createGain();
                n.connect(hp);
                hp.connect(gn);
                envGain(gn, t0, 0.001, 0.03, 0.0001, 0.05, 0.35);
                gn.connect(master);

                n.start(t0);
                n.stop(t0 + dur);
            }


            // party poppers: crisp multi-pop + crackle
            function sfxPoppers(strength = 1.0) {
                const ctx = ensureAudio();
                if (!ctx || !master) return;

                const t0 = ctx.currentTime + 0.006;
                const pops = 3;
                const rand = (a, b) => a + Math.random() * (b - a);

                for (let i = 0; i < pops; i++) {
                    const tt = t0 + i * 0.115 + rand(-0.01, 0.01);

                    // low transient "pop"
                    const o = ctx.createOscillator();
                    o.type = 'square';
                    o.frequency.setValueAtTime(rand(160, 230), tt);
                    o.frequency.exponentialRampToValueAtTime(rand(55, 75), tt + 0.05);

                    const g = ctx.createGain();
                    o.connect(g);
                    envGain(g, tt, 0.001, 0.028, 0.0001, 0.08, 0.28 * strength);
                    g.connect(master);
                    o.start(tt);
                    o.stop(tt + 0.16);

                    // crackle burst (noise with spikes)
                    const dur = 0.16;
                    const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
                    const data = buf.getChannelData(0);
                    for (let s = 0; s < data.length; s++) {
                        const base = (Math.random() * 2 - 1) * 0.12;
                        const spike = (Math.random() < 0.018) ? (Math.random() * 2 - 1) * 1.0 : 0;
                        data[s] = (base + spike) * Math.pow(1 - s / data.length, 1.2);
                    }
                    const n = ctx.createBufferSource();
                    n.buffer = buf;

                    const hp = ctx.createBiquadFilter();
                    hp.type = 'highpass';
                    hp.frequency.setValueAtTime(1700, tt);

                    const bp = ctx.createBiquadFilter();
                    bp.type = 'bandpass';
                    bp.frequency.setValueAtTime(3200, tt);
                    bp.Q.setValueAtTime(0.9, tt);

                    const gn = ctx.createGain();
                    n.connect(hp);
                    hp.connect(bp);
                    bp.connect(gn);
                    envGain(gn, tt, 0.001, 0.05, 0.0001, 0.10, 0.22 * strength);
                    gn.connect(master);

                    n.start(tt);
                    n.stop(tt + dur);

                    // small hiss tail only on last pop
                    if (i === pops - 1) {
                        const dur2 = 0.36;
                        const buf2 = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur2), ctx.sampleRate);
                        const d2 = buf2.getChannelData(0);
                        for (let s = 0; s < d2.length; s++) {
                            d2[s] = (Math.random() * 2 - 1) * 0.25 * Math.pow(1 - s / d2.length, 2.2);
                        }
                        const n2 = ctx.createBufferSource();
                        n2.buffer = buf2;

                        const lp = ctx.createBiquadFilter();
                        lp.type = 'lowpass';
                        lp.frequency.setValueAtTime(2600, tt);

                        const g2 = ctx.createGain();
                        n2.connect(lp);
                        lp.connect(g2);
                        envGain(g2, tt + 0.02, 0.004, 0.12, 0.0001, 0.22, 0.14 * strength);
                        g2.connect(master);

                        n2.start(tt + 0.01);
                        n2.stop(tt + dur2 + 0.05);
                    }
                }
            }



            // fireworks: whoosh + boom (one launch)
            function sfxFirework(delaySec = 0) {
                const ctx = ensureAudio();
                if (!ctx || !master) return;

                const t0 = ctx.currentTime + 0.006 + Math.max(0, delaySec);

                // WHOOSH (noise through bandpass sweep)
                const whooshDur = 0.55;
                const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * whooshDur), ctx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i = 0; i < d.length; i++) {
                    d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / d.length, 1.1);
                }
                const src = ctx.createBufferSource();
                src.buffer = buf;

                const bp = ctx.createBiquadFilter();
                bp.type = 'bandpass';
                bp.frequency.setValueAtTime(520, t0);
                bp.frequency.exponentialRampToValueAtTime(1400, t0 + whooshDur);
                bp.Q.setValueAtTime(0.75, t0);

                const g = ctx.createGain();
                g.gain.setValueAtTime(0.0001, t0);
                g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.12);
                g.gain.exponentialRampToValueAtTime(0.0001, t0 + whooshDur);

                src.connect(bp);
                bp.connect(g);
                g.connect(master);

                src.start(t0);
                src.stop(t0 + whooshDur);

                // BOOM (low oscillator + lowpassed noise) –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∂–µ
                const boomT = t0 + 0.56 + (Math.random() * 0.06);
                const boomDur = 1.15;

                const o = ctx.createOscillator();
                o.type = 'triangle';
                o.frequency.setValueAtTime(95, boomT);
                o.frequency.exponentialRampToValueAtTime(42, boomT + 0.55);

                const og = ctx.createGain();
                envGain(og, boomT, 0.006, 0.18, 0.0001, 0.70, 0.55);
                o.connect(og);

                // noise thump
                const nbuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * boomDur), ctx.sampleRate);
                const nd = nbuf.getChannelData(0);
                for (let i = 0; i < nd.length; i++) {
                    nd[i] = (Math.random() * 2 - 1) * 0.75 * Math.pow(1 - i / nd.length, 1.6);
                }
                const nsrc = ctx.createBufferSource();
                nsrc.buffer = nbuf;

                const lp = ctx.createBiquadFilter();
                lp.type = 'lowpass';
                lp.frequency.setValueAtTime(320, boomT);

                const ng = ctx.createGain();
                envGain(ng, boomT, 0.003, 0.22, 0.0001, 0.85, 0.34);

                // add slight "crackle" top
                const hp = ctx.createBiquadFilter();
                hp.type = 'highpass';
                hp.frequency.setValueAtTime(2400, boomT);

                const cg = ctx.createGain();
                envGain(cg, boomT + 0.02, 0.002, 0.10, 0.0001, 0.55, 0.12);

                nsrc.connect(lp);
                lp.connect(ng);
                ng.connect(master);

                nsrc.connect(hp);
                hp.connect(cg);
                cg.connect(master);

                og.connect(master);

                o.start(boomT);
                o.stop(boomT + boomDur);
                nsrc.start(boomT);
                nsrc.stop(boomT + boomDur);
            }

            function sfxFireworksShow() {
                // matches canvas show: 3 waves
                const times = [0.12, 2.28, 4.44];
                times.forEach((t) => {
                    // left/right almost together
                    sfxFirework(t + (Math.random() * 0.04));
                    sfxFirework(t + 0.06 + (Math.random() * 0.05));
                });
            }

            function sfxWind(ms = 6000) {
                const ctx = ensureAudio();
                if (!ctx || !master) return;

                const t0 = ctx.currentTime + 0.005;
                const dur = Math.max(0.4, ms / 1000);

                const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < data.length; i++) {
                    // pink-ish noise approximation
                    data[i] = (Math.random() * 2 - 1) * 0.65;
                }
                const src = ctx.createBufferSource();
                src.buffer = buf;
                src.loop = false;

                const bp = ctx.createBiquadFilter();
                bp.type = 'bandpass';
                bp.frequency.setValueAtTime(420, t0);
                bp.Q.setValueAtTime(0.8, t0);

                const lp = ctx.createBiquadFilter();
                lp.type = 'lowpass';
                lp.frequency.setValueAtTime(1400, t0);

                const g = ctx.createGain();
                g.gain.setValueAtTime(0.0001, t0);

                // slow amplitude wobble
                const lfo = ctx.createOscillator();
                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(0.35, t0);
                const lfoG = ctx.createGain();
                lfoG.gain.setValueAtTime(0.18, t0);
                lfo.connect(lfoG);
                lfoG.connect(g.gain);

                src.connect(bp);
                bp.connect(lp);
                lp.connect(g);
                g.connect(master);

                // envelope: fade in then fade out
                g.gain.exponentialRampToValueAtTime(0.42, t0 + 0.35);
                g.gain.exponentialRampToValueAtTime(0.22, t0 + Math.max(0.9, dur - 1.2));
                g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

                lfo.start(t0);
                src.start(t0);
                src.stop(t0 + dur);
                lfo.stop(t0 + dur);
            }

            updateSoundBtn();
            // unlock audio on first gesture
            window.addEventListener('pointerdown', ensureAudio, { once: true, passive: true });
            window.addEventListener('keydown', ensureAudio, { once: true });

            if (soundBtn) {
                soundBtn.addEventListener('click', () => {
                    sfxEnabled = !sfxEnabled;
                    localStorage.setItem('sfxEnabled', sfxEnabled ? '1' : '0');
                    updateSoundBtn();
                    if (sfxEnabled) ensureAudio();
                });
            }


            const palette = [
                ['rgba(120,180,255,.96)', 'rgba(120,180,255,.55)'],
                ['rgba(120,255,190,.96)', 'rgba(120,255,190,.50)'],
                ['rgba(255,220,120,.96)', 'rgba(255,220,120,.55)'],
                ['rgba(255,140,200,.96)', 'rgba(255,140,200,.55)'],
                ['rgba(180,120,255,.96)', 'rgba(180,120,255,.55)'],
                ['rgba(255,160,120,.96)', 'rgba(255,160,120,.50)'],
            ];
            const rand = (a, b) => a + Math.random() * (b - a);

            function showToast(text) {
                if (!toast) return;
                toast.textContent = text;
                toast.classList.remove('show');
                void toast.offsetWidth;
                toast.classList.add('show');
            }

            function partyOn(ms = 1900) {
                document.body.classList.add('party');
                if (treeGarland) treeGarland.classList.add('tg-fast');
                if (aurora) {
                    aurora.classList.remove('on');
                    void aurora.offsetWidth;
                    aurora.classList.add('on');
                }

                // speed-up top garland bulbs by forcing shorter duration for a moment
                if (topGarland) {
                    topGarland.querySelectorAll('.g-bulbPulse').forEach((el) => {
                        if (!el.dataset.dur) el.dataset.dur = getComputedStyle(el).animationDuration;
                        el.style.animationDuration = (0.85 + Math.random() * 0.45).toFixed(2) + 's';
                    });
                }

                setTimeout(() => {
                    document.body.classList.remove('party');
                    if (treeGarland) treeGarland.classList.remove('tg-fast');
                    if (topGarland) {
                        topGarland.querySelectorAll('.g-bulbPulse').forEach((el) => {
                            el.style.animationDuration = '';
                        });
                    }
                }, ms);
            }

            function shuffleTreeLights() {
                const bulbs = document.querySelectorAll('.tree-garland .tg-bulb');
                if (!bulbs.length) return;
                bulbs.forEach((b) => {
                    const c = palette[(Math.random() * palette.length) | 0];
                    b.style.setProperty('--fill', c[0]);
                    b.style.setProperty('--glow', c[1]);
                    b.style.setProperty('--delay', (-rand(0, 1.2)).toFixed(2) + 's');
                });
            }

            function sparkleStar() {
                if (!star) return;
                star.classList.remove('sparkle');
                void star.offsetWidth;
                star.classList.add('sparkle');

                const r = star.getBoundingClientRect();
                const x = r.left + r.width * 0.5;
                const y = r.top + r.height * 0.35;
                if (window.__fxStarburst) window.__fxStarburst(x, y, 34);
            }

            document.addEventListener('daychange', (e) => {
                if (reduce) return;

                const DUR = 6000;

                // 1) card pulse
                if (card) {
                    card.classList.remove('day-pulse');
                    void card.offsetWidth;
                    card.classList.add('day-pulse');
                }

                // 2) toast
                showToast(`‚ú® –ù–æ–≤—ã–π –¥–µ–Ω—å! –û—Å—Ç–∞–ª–æ—Å—å: ${e.detail.days} –¥–Ω.`);

                // 3) big confetti burst near card top
                const doBurst = (count = 120) => {
                    if (!window.__fxBurst) return;
                    if (card) {
                        const r = card.getBoundingClientRect();
                        window.__fxBurst(r.left + r.width / 2, r.top + Math.min(120, r.height * 0.22), count);
                    } else {
                        window.__fxBurst(window.innerWidth / 2, 180, count);
                    }
                };
                doBurst(140);
                // 3 waves of fireworks from left & right
                if (window.__fxFireworksShow) window.__fxFireworksShow(DUR);
                try { sfxFireworksShow(); } catch (_) { }

                try { sfxPoppers(1.0); } catch (_) { }

                // 4) garlands + aurora + star
                partyOn(DUR);
                shuffleTreeLights();
                sparkleStar();

                // retrigger aurora a couple of times for a longer show
                const retriggerAurora = () => {
                    if (!aurora) return;
                    aurora.classList.remove('on');
                    void aurora.offsetWidth;
                    aurora.classList.add('on');
                };
                setTimeout(retriggerAurora, 2600);
                setTimeout(retriggerAurora, 5200);

                // 5) snow gust + extra flakes (6 seconds)
                if (window.__snowGust) window.__snowGust(DUR, 1.35);
                if (window.__snowBurst) window.__snowBurst(240);

                // 6) sounds (require first user gesture, can be muted)
                try {
                    sfxChime();
                    sfxPop();
                    sfxPoppers(1.0);
                    sfxWind(DUR);
                } catch (_) { }

                // extra mini-bursts during the 6s window
                [1400, 2800, 4200, 5600].forEach((t, i) => {
                    setTimeout(() => {
                        shuffleTreeLights();
                        sparkleStar();
                        if (window.__snowBurst) window.__snowBurst(90);
                        doBurst(60);
                        if (Math.random() < 0.55 && window.__fxLaunchFirework) window.__fxLaunchFirework(Math.random() < 0.5 ? 'left' : 'right');
                        if (Math.random() < 0.35) { try { sfxFirework(0.0); } catch (_) { } }

                        if (i % 2 === 0) { try { sfxPoppers(0.85); } catch (_) { } } else { try { sfxPop(); } catch (_) { } }
                    }, t);
                });
            });
        })();

    </script>
    <div id="toast" class="toast" aria-live="polite"></div>

    <!-- Photo picker fallback (shows only if myphoto.jpg cannot be loaded) -->
    <button class="photo-picker" id="pickPhotoBtn" type="button" hidden>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <input id="pickPhotoInput" type="file" accept="image/*" hidden />

</body>
</html>
