<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í—Ä–µ–º—è –¥–æ –í–µ–Ω–µ—Ä—ã</title>
  <style>
    :root{
      --bg:#0b1220;          /* —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
      --card:#121a2b;        /* –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–∞–π–º–µ—Ä–∞ */
      --edge:#1c2842;        /* –ª—ë–≥–∫–∞—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ */
      --text:#eaf2ff;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted:#97a2bf;       /* –ø–æ–¥–ø–∏—Å–∏ */
      --accent:#70b8ff;      /* –∞–∫—Ü–µ–Ω—Ç */
      --accent-2:#ff8fb6;    /* –≤—Ç–æ—Ä–æ–π –∞–∫—Ü–µ–Ω—Ç */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,
      "Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #0e1830 0, var(--bg) 60%),
                  radial-gradient(800px 400px at 80% 20%, #0e1830 0, var(--bg) 60%), var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{
      text-align:center; padding:40px 16px 8px; line-height:1.2;
    }
    h1{margin:0; font-size:clamp(1.4rem, 3.5vw, 2.2rem); font-weight:800; letter-spacing:.3px}
    .sub{margin-top:6px; color:var(--muted); font-size:clamp(.9rem, 2.2vw, 1rem)}

    .wrap{max-width:1024px; margin:0 auto; padding:12px 16px 56px}

    .timer{
      display:grid; grid-template-columns:repeat(4, minmax(130px, 1fr)); gap:14px;
      align-items:stretch; margin-top:18px;
    }
    .unit{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08)), var(--card);
      border:1px solid var(--edge); border-radius:18px; padding:18px 16px; text-align:center;
      box-shadow:0 30px 50px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
      position:relative; overflow:hidden;
    }
    .unit::after{ /* –ª—ë–≥–∫–∏–π –±–ª–∏–∫ */
      content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%);
      pointer-events:none;
    }
    .label{color:var(--muted); font-weight:600; font-size:.92rem; letter-spacing:.32px; text-transform:uppercase}
    .value{
      font-variant-numeric:tabular-nums slashed-zero; line-height:1;
      margin-top:10px; font-weight:900; letter-spacing:.5px;
      font-size:clamp(2.4rem, 9vw, 4.4rem);
      text-shadow:0 6px 22px rgba(0,0,0,.45);
    }

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:18px}
    .btn{
      appearance:none; border:1px solid var(--edge); color:var(--text); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08));
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition:.2s transform, .2s filter, .2s background;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .hint{color:var(--muted); text-align:center; margin-top:6px; font-size:.92rem}

    /* –ü–æ–ª–Ω—ç–∫—Ä–∞–Ω–Ω—ã–π canvas —Å —Å–∞–ª—é—Ç–æ–º */
    #fx{position:fixed; inset:0; opacity:0; pointer-events:none; transition:opacity .35s ease; display:block; z-index:50;}
    #fx.show{opacity:1}

    /* –õ—ë–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ñ–æ–Ω–∞ –ø—Ä–∏ —Å–∞–ª—é—Ç–µ */
    #fxBack{
      position:fixed; inset:0; background:radial-gradient(1000px 500px at 50% 60%, rgba(255,255,255,.05), rgba(0,0,0,.7));
      opacity:0; pointer-events:none; transition:opacity .35s ease; z-index:49;
    }
    #fxBack.show{opacity:1}

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 640px){
      .timer{grid-template-columns:repeat(2, minmax(130px,1fr))}
    }
  </style>
</head>
<body>
  <header>
    <h1>–í—Ä–µ–º—è –¥–æ <span id="targetLabel">–í–µ–Ω–µ—Ä—ã</span></h1>
    <div class="sub"></div>
  </header>

  <div class="wrap">
    <section class="timer" role="timer" aria-live="polite" aria-atomic="true">
      <article class="unit" aria-label="–î–Ω–∏">
        <div class="label">–î–Ω–∏</div>
        <div class="value" id="d">00</div>
      </article>
      <article class="unit" aria-label="–ß–∞—Å—ã">
        <div class="label">–ß–∞—Å—ã</div>
        <div class="value" id="h">00</div>
      </article>
      <article class="unit" aria-label="–ú–∏–Ω—É—Ç—ã">
        <div class="label">–ú–∏–Ω—É—Ç—ã</div>
        <div class="value" id="m">00</div>
      </article>
      <article class="unit" aria-label="–°–µ–∫—É–Ω–¥—ã">
        <div class="label">–°–µ–∫—É–Ω–¥—ã</div>
        <div class="value" id="s">00</div>
      </article>
    </section>

    <div class="controls">
      <button class="btn" id="soundBtn" aria-pressed="false" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">üîá –ó–≤—É–∫ –≤—ã–∫–ª.</button>
    
    </div>
    <div class="hint"></div>
  </div>

  <!-- –ü–æ–¥–ª–æ–∂–∫–∞ –∏ –∫–∞–Ω–≤–∞—Å —Å–∞–ª—é—Ç–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö) -->
  <div id="fxBack" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true"></canvas>

<script>
(function(){
  // ---------- –£–¢–ò–õ–ò–¢–´ –î–ê–¢–´ ----------
  function getTargetNov1(){
    const now = new Date();
    const year = now.getFullYear();
    let target = new Date(year, 10, 1, 0, 0, 0, 0); // –º–µ—Å—è—Ü 10 = –Ω–æ—è–±—Ä—å
    if (now >= target) target = new Date(year + 1, 10, 1, 0, 0, 0, 0);
    return target;
  }
  const targetLabel = document.getElementById('targetLabel');
  let TARGET = getTargetNov1();
  targetLabel.textContent = `–í–µ–Ω–µ—Ä—ã`;

  const dom = { d: document.getElementById('d'), h: document.getElementById('h'), m: document.getElementById('m'), s: document.getElementById('s') };
  const pad2 = n => String(n).padStart(2,'0');

  let prevDays = null;

  function compute(){
    const now = new Date();
    if (now >= TARGET) { // –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≥–æ–¥–∞–º–∏ :)
      TARGET = getTargetNov1();
      targetLabel.textContent = `–í–µ–Ω–µ—Ä—ã`;
    }
    let diff = TARGET - now; if (diff < 0) diff = 0;
    const totalSec = Math.floor(diff / 1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    const secs = totalSec % 60;

    dom.d.textContent = pad2(days);
    dom.h.textContent = pad2(hours);
    dom.m.textContent = pad2(mins);
    dom.s.textContent = pad2(secs);

    if (prevDays !== null && days !== prevDays) {
      triggerFireworks(10_000);
    }
    prevDays = days;
  }
  compute();
  setInterval(compute, 250);

  // ---------- –ê–£–î–ò–û (Web Audio API) ----------
  let audioCtx = null;
  let audioEnabled = false;

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function playWhistle(duration = 0.9, style = 'rise'){
  if (typeof audioEnabled !== 'undefined' && !audioEnabled) return;
  if (typeof ensureAudio === 'function') ensureAudio();
  const ctx = (typeof audioCtx !== 'undefined') ? audioCtx : (window.audioCtx || new (window.AudioContext || window.webkitAudioContext)());
  window.audioCtx = ctx;
  const t0  = ctx.currentTime;

  // Core nodes
  const osc    = ctx.createOscillator();
  const filter = ctx.createBiquadFilter();
  const gain   = ctx.createGain();
  const panner = (ctx.createStereoPanner ? ctx.createStereoPanner() : null);

  // Gentle air hiss for realism
  const hissBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * duration), ctx.sampleRate);
  const hiss    = ctx.createBufferSource(); hiss.buffer = hissBuf;
  const hissF   = ctx.createBiquadFilter(); hissF.type = 'bandpass';
  const hissG   = ctx.createGain();

  // Fill noise (decaying envelope)
  const ch = hissBuf.getChannelData(0);
  for (let i=0;i<ch.length;i++){
    const t = i / hissBuf.sampleRate;
    ch[i] = (Math.random()*2 - 1) * (1 - t);
  }

  // Vibrato via LFO
  const lfo     = ctx.createOscillator();
  const lfoGain = ctx.createGain();

  // Amplitude envelope
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.22, t0 + 0.06);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);

  // Routing
  osc.connect(filter).connect(gain);
  if (panner){ gain.connect(panner); panner.connect(ctx.destination); }
  else { gain.connect(ctx.destination); }

  hiss.connect(hissF).connect(hissG).connect(ctx.destination);

  // Presets
  let S;
  const presets = {
    rise:   { wave:'triangle', f0: 800+Math.random()*150, f1: 1900+Math.random()*450, vibHz:6.5, vibAmtHz:18, q:14, fil0:1100, fil1:2800, hiss:0.03 },
    warble: { wave:'sawtooth', f0: 950,                   f1: 1500,                   vibHz:12,  vibAmtHz:40, q:18, fil0:1300, fil1:2200, hiss:0.035 },
    fall:   { wave:'triangle', f0: 2200,                  f1: 850,                    vibHz:7.5, vibAmtHz:16, q:12, fil0:2600, fil1:1200, hiss:0.025 },
    thin:   { wave:'sine',     f0: 1000,                  f1: 2000,                   vibHz:8.0, vibAmtHz:10, q:22, fil0:1400, fil1:2600, hiss:0.02 },
  };
  S = presets[style] || { wave:'triangle', f0:900, f1:2000, vibHz:6.5, vibAmtHz:18, q:14, fil0:1200, fil1:2800, hiss:0.03 };

  // Configure nodes
  osc.type = S.wave;
  osc.frequency.setValueAtTime(S.f0, t0);
  osc.frequency.exponentialRampToValueAtTime(S.f1, t0 + duration * 0.9);

  filter.type = 'bandpass';
  filter.Q.setValueAtTime(S.q, t0);
  filter.frequency.setValueAtTime(S.fil0, t0);
  filter.frequency.exponentialRampToValueAtTime(S.fil1, t0 + duration * 0.9);

  // Vibrato
  lfo.frequency.setValueAtTime(S.vibHz, t0);
  lfoGain.gain.setValueAtTime(S.vibAmtHz, t0);
  lfo.connect(lfoGain);
  lfoGain.connect(osc.frequency);

  // Hiss
  hissF.frequency.setValueAtTime((S.f0+S.f1)/2, t0);
  hissF.Q.setValueAtTime(S.q*0.8, t0);
  hissG.gain.setValueAtTime(S.hiss, t0);
  hiss.start(t0); hiss.stop(t0 + duration);

  // Slight random stereo position
  if (panner) panner.pan.setValueAtTime((Math.random()*2 - 1) * 0.25, t0);

  // Start/stop
  osc.start(t0);    osc.stop(t0 + duration);
  lfo.start(t0);    lfo.stop(t0 + duration + 0.01);
}

  function playExplosion(){
    if (!audioEnabled) return;
    ensureAudio();
    const ctx = audioCtx; const t0 = ctx.currentTime;

    // –ù–∏–∑–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–π ¬´–±—É–º¬ª
    const boomOsc = ctx.createOscillator();
    const boomGain = ctx.createGain();
    boomOsc.type = 'sine';
    boomOsc.frequency.setValueAtTime(90, t0);
    boomOsc.frequency.exponentialRampToValueAtTime(45, t0 + 1.0);
    boomGain.gain.setValueAtTime(0.6, t0);
    boomGain.gain.exponentialRampToValueAtTime(0.001, t0 + 1.2);
    boomOsc.connect(boomGain).connect(ctx.destination);
    boomOsc.start(t0); boomOsc.stop(t0 + 1.3);

    // –®—É–º–æ–≤–æ–π –≤–∑—Ä—ã–≤ —Å –ø–æ–ª–æ—Å–æ–≤–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    const buffer = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      data[i] = (Math.random() * 2 - 1) * (1 - i / data.length); // –∑–∞—Ç—É—Ö–∞—é—â–∏–π –±–µ–ª—ã–π —à—É–º
    }
    const noise = ctx.createBufferSource(); noise.buffer = buffer;
    const band = ctx.createBiquadFilter(); band.type = 'bandpass'; band.frequency.setValueAtTime(2200, t0);
    const nGain = ctx.createGain();
    nGain.gain.setValueAtTime(0.001, t0);
    nGain.gain.exponentialRampToValueAtTime(0.8, t0 + 0.05);
    nGain.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.4);
    noise.connect(band).connect(nGain).connect(ctx.destination);
    noise.start(t0); noise.stop(t0 + 1.5);

    // –ü–æ—Ç—Ä–µ—Å–∫–∏–≤–∞–Ω–∏—è –∏—Å–∫—Ä
    for (let k = 0; k < 6; k++) {
      playCrackle(t0 + 0.2 + Math.random() * 0.6);
    }
  }

  function playCrackle(atTime){
    if (!audioEnabled) return;
    ensureAudio();
    const ctx = audioCtx;
    const dur = 0.15;
    const buffer = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) {
      const t = i / buffer.sampleRate;
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - t, 2) * (Math.random() > 0.8 ? 1.0 : 0.6);
    }
    const src = ctx.createBufferSource(); src.buffer = buffer;
    const g = ctx.createGain(); g.gain.setValueAtTime(0.25, atTime); g.gain.exponentialRampToValueAtTime(0.001, atTime + dur);
    src.connect(g).connect(ctx.destination);
    src.start(atTime);
  }

  // ---------- –í–ò–ó–£–ê–õ–¨–ù–´–ô –°–ê–õ–Æ–¢ (Canvas) ----------
  const canvas = document.getElementById('fx');
  const back = document.getElementById('fxBack');
  const ctx2d = canvas.getContext('2d');
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  function resizeCanvas(){
    const { innerWidth:w, innerHeight:h } = window;
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx2d.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', resizeCanvas, { passive:true });
  resizeCanvas();

  const GRAVITY = 90; // px/s^2
  const AIR = 0.995;  // –ª—ë–≥–∫–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ

  class Particle{
    constructor(x, y, angle, speed, color){
      this.x=x; this.y=y; this.vx=Math.cos(angle)*speed; this.vy=Math.sin(angle)*speed;
      this.alpha=1; this.life = 0.9 + Math.random()*0.6; // —Å–µ–∫
      this.color=color; this.size=1.4 + Math.random()*2.2; this.spark = Math.random() < 0.2;
    }
    update(dt){
      this.vy += GRAVITY * dt;
      this.vx *= AIR; this.vy *= AIR;
      this.x += this.vx * dt; this.y += this.vy * dt;
      this.alpha -= dt / this.life;
    }
    draw(ctx){
      if (this.alpha <= 0) return;
      ctx.globalAlpha = Math.max(0, this.alpha);
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
      ctx.fillStyle = this.color;
      ctx.fill();
      if (this.spark && Math.random() < 0.4){ // –º–∞–ª–µ–Ω—å–∫–∏–µ –∏—Å–∫—Ä—ã –≤–æ–∫—Ä—É–≥
        ctx.globalAlpha = Math.max(0, this.alpha*0.7);
        ctx.fillRect(this.x + (Math.random()-0.5)*6, this.y + (Math.random()-0.5)*6, 1.2, 1.2);
      }
      ctx.globalAlpha = 1;
    }
  }

  class Rocket{
    constructor(w, h){
      this.x = w*0.1 + Math.random()*w*0.8;
      this.y = h + 12;
      this.vx = (Math.random()-0.5)*40;
      this.vy = -(260 + Math.random()*220);
      this.targetY = h * (0.22 + Math.random()*0.4);
      this.exploded = false;
      this.trail = [];
      this.hue = Math.floor(Math.random()*360);
      this.color = `hsl(${this.hue} 100% 65%)`;
      this.swishPlayed = false;
    }
    update(dt){
      if (this.exploded) return;
      this.vy += 120 * dt; // —Ç—è–Ω–µ—Ç –≤–Ω–∏–∑
      this.x += this.vx * dt; this.y += this.vy * dt;
      this.trail.push({x:this.x, y:this.y, a:1}); if (this.trail.length > 12) this.trail.shift();
      if (!this.swishPlayed){ playWhistle(0.9); this.swishPlayed = true; }
      if (this.vy > -40 || this.y <= this.targetY){ this.explode(); }
    }
    explode(){
      if (this.exploded) return; this.exploded = true;
      // –û—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
      const count = 120 + Math.floor(Math.random()*80);
      for (let i=0;i<count;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 90 + Math.random()*260;
        fireworks.particles.push(new Particle(this.x, this.y, angle, speed, this.color));
      }
      // –ñ—ë–ª—Ç—ã–µ –∏—Å–∫—Ä—ã
      for (let i=0;i<30;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 40 + Math.random()*80;
        fireworks.particles.push(new Particle(this.x, this.y, angle, speed, '#fff7d6'));
      }
      playExplosion();
    }
    draw(ctx){
      if (this.exploded) return;
      // –®–ª–µ–π—Ñ
      ctx.strokeStyle = this.color;
      ctx.lineWidth = 2;
      ctx.globalAlpha = .7;
      ctx.beginPath();
      for (let i=0;i<this.trail.length;i++){
        const t = this.trail[i]; i===0 ? ctx.moveTo(t.x, t.y) : ctx.lineTo(t.x, t.y);
      }
      ctx.stroke(); ctx.globalAlpha = 1;
      // –ì–æ–ª–æ–≤–∞ —Ä–∞–∫–µ—Ç—ã
      ctx.beginPath(); ctx.arc(this.x, this.y, 2.2, 0, Math.PI*2); ctx.fillStyle=this.color; ctx.fill();
    }
  }

  const fireworks = {
    running:false,
    rockets:[], particles:[], last:0, endAt:0,
    _failsafe: null,
    start(durationMs=10000){
      // –µ—Å–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–º —á–∏—Å—Ç–æ
      if (this.running) this.stop();
      this.running = true;
      back.classList.add('show'); canvas.classList.add('show');
      this.last = performance.now(); this.endAt = this.last + durationMs;
      // –§–µ–π–ª—Å–µ–π—Ñ: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
      this._failsafe = setTimeout(() => {
        if (this.running) this.stop();
      }, durationMs + 2000);
      this.loop();
    },
    stop(){
      this.running = false; 
      if (this._failsafe){ clearTimeout(this._failsafe); this._failsafe = null; }
      this.rockets.length = 0; this.particles.length = 0;
      back.classList.remove('show'); canvas.classList.remove('show');
      ctx2d.clearRect(0,0,canvas.width,canvas.height);
    },
    spawnRocket(){ this.rockets.push(new Rocket(canvas.width, canvas.height)); },
    loop(){
      if (!this.running) return;
      const now = performance.now();
      const dt = Math.min((now - this.last) / 1000, 0.035); // –æ–≥—Ä–∞–Ω–∏—á–∏–º dt –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      this.last = now;

      // —Ñ–æ–Ω–æ–≤–∞—è –¥—ã–º–∫–∞
      ctx2d.fillStyle = 'rgba(0,0,0,.20)';
      ctx2d.fillRect(0,0,canvas.width,canvas.height);

      // –°–ø–∞—É–Ω–∏–º —Ä–∞–∫–µ—Ç—ã –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
      if (now < this.endAt) {
        if (Math.random() < 0.14) this.spawnRocket();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ / —Ä–∏—Å–æ–≤–∞–Ω–∏–µ
      for (const r of this.rockets) { r.update(dt); r.draw(ctx2d); }
      // –£–î–ê–õ–Ø–ï–ú –≤–∑–æ—Ä–≤–∞–≤—à–∏–µ—Å—è —Ä–∞–∫–µ—Ç—ã —Å—Ä–∞–∑—É, –∏–Ω–∞—á–µ –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞ –∏–∑-–∑–∞ –Ω–µ—Å–∂–∏–º–∞—é—â–µ–≥–æ—Å—è —Å–ª–µ–¥–∞
      this.rockets = this.rockets.filter(r => !r.exploded);

      ctx2d.globalCompositeOperation = 'lighter';
      for (const p of this.particles) { p.update(dt); p.draw(ctx2d); }
      ctx2d.globalCompositeOperation = 'source-over';
      this.particles = this.particles.filter(p => p.alpha > 0 && p.y < canvas.height + 80);

      // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –∫–æ–≥–¥–∞ –≤—Å—ë –ø–æ–≥–∞—Å–ª–æ ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
      if (now >= this.endAt && this.rockets.length === 0 && this.particles.length === 0) {
        this.stop(); return;
      }
      requestAnimationFrame(this.loop.bind(this));
    }
  };

  function triggerFireworks(ms){ fireworks.start(ms || 10_000); }

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  const soundBtn = document.getElementById('soundBtn');
  const testBtn  = document.getElementById('testBtn');

  soundBtn.addEventListener('click', async () => {
    if (!audioCtx) ensureAudio();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    audioEnabled = !audioEnabled;
    soundBtn.setAttribute('aria-pressed', String(audioEnabled));
    soundBtn.textContent = audioEnabled ? 'üîä –ó–≤—É–∫ –≤–∫–ª.' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª.';
  });

  testBtn.addEventListener('click', () => triggerFireworks(5000));
})();
</script>
</body>
</html>
